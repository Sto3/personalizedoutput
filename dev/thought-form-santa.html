<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Santa Message Thought Organizer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,500;1,400&display=swap');

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Lora', Georgia, serif;
      background: #ffffff;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      color: #2d2d2d;
    }

    /* Festive garland header - clean Christmas green with ornaments */
    .garland-header {
      width: 100%;
      height: 100px;
      background: linear-gradient(180deg, #0d3320 0%, #1a4d2e 40%, #fff 100%);
      position: relative;
      overflow: hidden;
    }

    .garland-header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70px;
      background:
        radial-gradient(ellipse 60px 40px at 10% 100%, #1a4d2e 70%, transparent 71%),
        radial-gradient(ellipse 80px 50px at 25% 100%, #0d3320 70%, transparent 71%),
        radial-gradient(ellipse 70px 45px at 42% 100%, #1a4d2e 70%, transparent 71%),
        radial-gradient(ellipse 85px 55px at 60% 100%, #0d3320 70%, transparent 71%),
        radial-gradient(ellipse 65px 42px at 78% 100%, #1a4d2e 70%, transparent 71%),
        radial-gradient(ellipse 75px 48px at 95% 100%, #0d3320 70%, transparent 71%);
    }

    .garland-header::after {
      content: '';
      position: absolute;
      bottom: 15px;
      left: 0;
      right: 0;
      height: 40px;
      background:
        radial-gradient(circle 8px at 12% 50%, #c41e3a 90%, transparent 91%),
        radial-gradient(circle 6px at 22% 70%, #d4af37 90%, transparent 91%),
        radial-gradient(circle 7px at 35% 45%, #c41e3a 90%, transparent 91%),
        radial-gradient(circle 5px at 48% 65%, #d4af37 90%, transparent 91%),
        radial-gradient(circle 8px at 62% 50%, #c41e3a 90%, transparent 91%),
        radial-gradient(circle 6px at 75% 70%, #d4af37 90%, transparent 91%),
        radial-gradient(circle 7px at 88% 55%, #c41e3a 90%, transparent 91%);
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 30px 20px 60px;
    }

    h1 {
      font-family: 'Playfair Display', Georgia, serif;
      text-align: center;
      color: #1a4d2e;
      margin-bottom: 8px;
      font-size: 2rem;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1rem;
      line-height: 1.6;
      font-style: italic;
    }

    /* Start Screen */
    .start-screen {
      background: #fafafa;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
    }

    .start-screen .intro-text {
      color: #444;
      margin-bottom: 30px;
      line-height: 1.8;
      text-align: left;
      font-size: 1rem;
    }

    .start-screen .intro-text p {
      margin-bottom: 16px;
    }

    .start-screen .intro-text p:last-child {
      margin-bottom: 0;
    }

    .btn-start {
      background: linear-gradient(135deg, #c41e3a 0%, #9b1b30 100%);
      color: white;
      border: none;
      padding: 16px 48px;
      font-size: 1.1rem;
      font-family: 'Lora', Georgia, serif;
      border-radius: 30px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 20px;
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(196, 30, 58, 0.35);
    }

    /* Form Area */
    .form-area {
      display: none;
    }

    .form-area.active {
      display: block;
    }

    /* Previous Answers */
    .previous-answers {
      margin-bottom: 24px;
    }

    .previous-answers h3 {
      color: #1a4d2e;
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .previous-answers .helper-text {
      color: #777;
      font-size: 0.9rem;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .answer-pair {
      background: #f9f9f9;
      border-left: 3px solid #1a4d2e;
      padding: 12px 16px;
      margin-bottom: 10px;
      border-radius: 0 8px 8px 0;
    }

    .answer-pair .question {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .answer-pair .answer {
      color: #333;
      font-size: 0.95rem;
    }

    .no-answers {
      color: #999;
      font-style: italic;
      font-size: 0.9rem;
    }

    /* Current Question */
    .current-question {
      background: #fafafa;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 30px;
    }

    .current-question-header {
      color: #1a4d2e;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .current-question-hint {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 16px;
    }

    .question-label {
      color: #2d2d2d;
      font-size: 1.15rem;
      font-weight: 500;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .answer-input {
      width: 100%;
      min-height: 120px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      font-size: 1rem;
      color: #333;
      resize: vertical;
      font-family: inherit;
    }

    .answer-input:focus {
      outline: none;
      border-color: #1a4d2e;
      box-shadow: 0 0 0 2px rgba(26, 77, 46, 0.1);
    }

    .answer-input::placeholder {
      color: #aaa;
    }

    .btn-next {
      background: linear-gradient(135deg, #c41e3a 0%, #9b1b30 100%);
      color: white;
      border: none;
      padding: 14px 36px;
      font-size: 1rem;
      font-family: 'Lora', Georgia, serif;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-next:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(196, 30, 58, 0.35);
    }

    .btn-next:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Summary Screen */
    .summary-screen {
      display: none;
    }

    .summary-screen.active {
      display: block;
    }

    .summary-screen h2 {
      font-family: 'Playfair Display', Georgia, serif;
      color: #1a4d2e;
      margin-bottom: 16px;
    }

    .summary-screen .body-text {
      color: #555;
      line-height: 1.8;
      margin-bottom: 24px;
      font-size: 1rem;
    }

    .summary-content {
      background: #f9f9f9;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      max-height: 300px;
      overflow-y: auto;
    }

    .summary-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .summary-item .q {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .summary-item .a {
      color: #333;
    }

    .btn-generate {
      background: linear-gradient(135deg, #c41e3a 0%, #9b1b30 100%);
      color: white;
      border: none;
      padding: 18px 48px;
      font-size: 1.1rem;
      font-weight: 600;
      font-family: 'Lora', Georgia, serif;
      border-radius: 30px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-generate:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(196, 30, 58, 0.35);
    }

    .btn-generate:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Result Screen */
    .result-screen {
      display: none;
    }

    .result-screen.active {
      display: block;
    }

    .result-screen h2 {
      font-family: 'Playfair Display', Georgia, serif;
      color: #1a4d2e;
      margin-bottom: 20px;
    }

    .result-content {
      background: #f9f9f9;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 24px;
      white-space: pre-wrap;
      line-height: 1.8;
      font-size: 1.05rem;
      color: #333;
      margin-bottom: 20px;
    }

    .audio-player {
      background: linear-gradient(135deg, #1a4d2e 0%, #0d3320 100%);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .audio-player h4 {
      color: #fff;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }

    .audio-player audio {
      width: 100%;
    }

    .result-note {
      color: #777;
      font-size: 0.9rem;
      font-style: italic;
      margin-bottom: 20px;
    }

    .btn-restart {
      background: #fff;
      color: #1a4d2e;
      border: 2px solid #1a4d2e;
      padding: 12px 30px;
      font-size: 0.95rem;
      font-family: 'Lora', Georgia, serif;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-restart:hover {
      background: #1a4d2e;
      color: #fff;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e8e8e8;
      border-top-color: #c41e3a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress indicator */
    .progress {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e0e0e0;
    }

    .progress-dot.completed {
      background: #1a4d2e;
    }

    .progress-dot.current {
      background: #c41e3a;
      box-shadow: 0 0 10px rgba(196, 30, 58, 0.4);
    }

    /* Error state */
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* Red ribbon footer with bow */
    .ribbon-footer {
      width: 100%;
      height: 80px;
      background: linear-gradient(180deg, #fff 0%, #f8f8f8 20%, #c41e3a 20%, #9b1b30 100%);
      margin-top: 40px;
      position: relative;
    }

    /* Bow center */
    .ribbon-footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 60px;
      background: radial-gradient(circle at 50% 50%, #e63950 0%, #c41e3a 40%, #9b1b30 100%);
      border-radius: 50%;
      box-shadow: 0 4px 15px rgba(196, 30, 58, 0.4);
      z-index: 2;
    }

    /* Bow loops */
    .ribbon-footer::after {
      content: '';
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 140px;
      height: 50px;
      background:
        radial-gradient(ellipse 45px 30px at 25% 50%, #c41e3a 70%, transparent 71%),
        radial-gradient(ellipse 45px 30px at 75% 50%, #c41e3a 70%, transparent 71%);
      z-index: 1;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Festive garland header -->
  <div class="garland-header"></div>

  <div class="container">
    <h1>Personalized Santa Audio Message</h1>
    <p class="subtitle">Instant · Heartwarming · Made From Your Stories</p>

    <!-- Start Screen -->
    <div id="startScreen" class="start-screen">
      <div class="intro-text">
        <p>In a few thoughtful questions, we'll help you remember the moments, details, and quiet acts of courage that you most want Santa to notice about your child.</p>
        <p>This isn't a quiz and it's not therapy. It's a focused space to organize your thoughts so the final Santa message feels specific, honest, and deeply personal — without any pressure on you to "say it perfectly."</p>
      </div>
      <button class="btn-start" onclick="startSession()">Begin the questions</button>
    </div>

    <!-- Form Area -->
    <div id="formArea" class="form-area">
      <div id="progress" class="progress"></div>

      <div id="previousAnswers" class="previous-answers">
        <h3>What you've shared so far</h3>
        <p class="helper-text">As you go, you'll see your earlier answers here. There are no "right" answers — we're just collecting the details that will help shape your child's message.</p>
        <div id="answersList"></div>
      </div>

      <div id="currentQuestion" class="current-question">
        <div class="current-question-header">Current question</div>
        <div class="current-question-hint">Your next question may change slightly based on what you've already shared.</div>
        <div id="questionLabel" class="question-label"></div>
        <textarea
          id="answerInput"
          class="answer-input"
          placeholder="Type your answer here..."
          onkeydown="handleKeyDown(event)"
        ></textarea>
        <button id="nextBtn" class="btn-next" onclick="submitAnswer()">Next</button>
      </div>

      <div id="loadingQuestion" class="loading hidden">
        <div class="spinner"></div>
        <p>Thinking...</p>
      </div>
    </div>

    <!-- Summary Screen -->
    <div id="summaryScreen" class="summary-screen">
      <h2>You've reached the end of the questions</h2>
      <p class="body-text">You've just done the hardest and most important part: putting into words what this year has really been like for your child, and what you most want them to hear.</p>
      <p class="body-text">When you click below, we'll use everything you've shared to create a personalized Santa message that names their courage, kindness, and growth in a way that feels true to them.</p>
      <div id="summaryContent" class="summary-content"></div>
      <button class="btn-generate" onclick="generateMessage()">Generate Santa message</button>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="result-screen">
      <h2>Your personalized Santa message is ready</h2>
      <div id="resultContent" class="result-content"></div>
      <div id="audioPlayer" class="audio-player hidden">
        <h4>Listen to the message</h4>
        <audio id="audioElement" controls></audio>
      </div>
      <p class="result-note">You'll receive this as your final digital file. For now, this is a developer preview of the content and audio.</p>
      <button class="btn-restart" onclick="restart()">Start Over</button>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay" class="error hidden"></div>
  </div>

  <!-- Red ribbon footer -->
  <div class="ribbon-footer"></div>

  <script>
    const API_BASE = '/api/thought-chat';

    let sessionId = null;
    let currentQuestion = '';
    let answers = []; // Array of {question, answer} pairs
    let questionCount = 0;

    async function startSession() {
      hideError();
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('formArea').classList.add('active');
      showLoading(true);

      try {
        const response = await fetch(`${API_BASE}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: 'santa_message' })
        });

        if (!response.ok) throw new Error('Failed to start session');

        const data = await response.json();
        sessionId = data.sessionId;
        // Handle both possible field names
        currentQuestion = data.firstAssistantMessage || data.message || '';
        questionCount = 1;

        showLoading(false);
        displayQuestion();
        updateProgress();

      } catch (err) {
        showError(err.message);
        showLoading(false);
      }
    }

    function displayQuestion() {
      document.getElementById('questionLabel').textContent = currentQuestion;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
      document.getElementById('currentQuestion').classList.remove('hidden');

      updateAnswersList();
    }

    function updateAnswersList() {
      const list = document.getElementById('answersList');

      if (answers.length === 0) {
        list.innerHTML = '<p class="no-answers">Your previous answers will appear here.</p>';
        return;
      }

      list.innerHTML = answers.map((item, i) => `
        <div class="answer-pair">
          <div class="question">${escapeHtml(item.question)}</div>
          <div class="answer">${escapeHtml(item.answer)}</div>
        </div>
      `).join('');
    }

    function updateProgress() {
      const progress = document.getElementById('progress');
      const maxDots = 10; // Approximate max questions

      let dots = '';
      for (let i = 0; i < maxDots; i++) {
        if (i < questionCount - 1) {
          dots += '<div class="progress-dot completed"></div>';
        } else if (i === questionCount - 1) {
          dots += '<div class="progress-dot current"></div>';
        } else {
          dots += '<div class="progress-dot"></div>';
        }
      }
      progress.innerHTML = dots;
    }

    async function submitAnswer() {
      const input = document.getElementById('answerInput');
      const answer = input.value.trim();

      if (!answer) return;

      hideError();

      // Store the Q&A pair
      answers.push({ question: currentQuestion, answer: answer });

      document.getElementById('currentQuestion').classList.add('hidden');
      showLoading(true);

      try {
        const response = await fetch(`${API_BASE}/continue`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, userMessage: answer })
        });

        if (!response.ok) throw new Error('Failed to continue session');

        const data = await response.json();

        if (data.status === 'ready_for_generation') {
          // Show summary screen
          showLoading(false);
          document.getElementById('formArea').classList.remove('active');
          showSummary();
        } else {
          // Next question - handle both field names
          currentQuestion = data.assistantMessage || data.message || '';
          questionCount++;
          showLoading(false);
          displayQuestion();
          updateProgress();
        }

      } catch (err) {
        showError(err.message);
        showLoading(false);
        document.getElementById('currentQuestion').classList.remove('hidden');
      }
    }

    function showSummary() {
      const content = document.getElementById('summaryContent');
      content.innerHTML = answers.map(item => `
        <div class="summary-item">
          <div class="q">${escapeHtml(item.question)}</div>
          <div class="a">${escapeHtml(item.answer)}</div>
        </div>
      `).join('');

      document.getElementById('summaryScreen').classList.add('active');
    }

    async function generateMessage() {
      hideError();
      document.getElementById('summaryScreen').classList.remove('active');
      document.getElementById('formArea').classList.add('active');
      showLoading(true);
      document.getElementById('previousAnswers').classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId })
        });

        if (!response.ok) throw new Error('Failed to generate message');

        const data = await response.json();

        showLoading(false);
        document.getElementById('formArea').classList.remove('active');
        showResult(data.output);

      } catch (err) {
        showError(err.message);
        showLoading(false);
        document.getElementById('summaryScreen').classList.add('active');
        document.getElementById('formArea').classList.remove('active');
      }
    }

    function showResult(output) {
      // Handle different output formats
      let messageText = '';
      let audioUrl = null;

      if (typeof output === 'string') {
        messageText = output;
      } else if (typeof output === 'object') {
        // Try various field names for the message text
        messageText = output.messageText || output.script || output.message || output.text || '';

        // Try various field names for audio URL
        audioUrl = output.audioUrl || output.audioPath || output.audio || null;

        // If audioPath is a relative path, make it absolute
        if (audioUrl && !audioUrl.startsWith('http') && !audioUrl.startsWith('/')) {
          audioUrl = '/outputs/' + audioUrl;
        }

        // If we still don't have message text, show formatted JSON
        if (!messageText) {
          messageText = JSON.stringify(output, null, 2);
        }
      }

      document.getElementById('resultContent').textContent = messageText;

      // Show audio player if we have an audio URL
      const audioPlayer = document.getElementById('audioPlayer');
      const audioElement = document.getElementById('audioElement');

      if (audioUrl) {
        audioElement.src = audioUrl;
        audioPlayer.classList.remove('hidden');
      } else {
        audioPlayer.classList.add('hidden');
      }

      document.getElementById('resultScreen').classList.add('active');
    }

    function restart() {
      sessionId = null;
      currentQuestion = '';
      answers = [];
      questionCount = 0;

      document.getElementById('resultScreen').classList.remove('active');
      document.getElementById('summaryScreen').classList.remove('active');
      document.getElementById('formArea').classList.remove('active');
      document.getElementById('previousAnswers').classList.remove('hidden');
      document.getElementById('startScreen').style.display = 'block';
      document.getElementById('audioPlayer').classList.add('hidden');
      hideError();
    }

    function showLoading(show) {
      document.getElementById('loadingQuestion').classList.toggle('hidden', !show);
      document.getElementById('nextBtn').disabled = show;
    }

    function showError(message) {
      const el = document.getElementById('errorDisplay');
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('errorDisplay').classList.add('hidden');
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && event.metaKey) {
        submitAnswer();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
