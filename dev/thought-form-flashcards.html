<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Flash Cards for Your Child | Personalized Output</title>
  <meta name="description" content="Create personalized learning flash cards designed specifically for YOUR child - using their interests, addressing their specific struggles, and matching their unique learning style.">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=Patrick+Hand&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Nunito', -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f64f59 100%);
      min-height: 100vh;
      color: #fff;
    }

    /* Playful header with stars */
    .wave-header {
      width: 100%;
      height: 120px;
      background: linear-gradient(180deg, #5a67d8 0%, #667eea 60%, transparent 100%);
      position: relative;
      overflow: hidden;
    }

    .wave-header::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 80px;
      background:
        radial-gradient(circle 3px at 10% 40%, rgba(255,255,255,0.8) 100%, transparent 100%),
        radial-gradient(circle 2px at 25% 60%, rgba(255,255,255,0.6) 100%, transparent 100%),
        radial-gradient(circle 4px at 45% 30%, rgba(255,255,255,0.7) 100%, transparent 100%),
        radial-gradient(circle 2px at 65% 50%, rgba(255,255,255,0.5) 100%, transparent 100%),
        radial-gradient(circle 3px at 85% 35%, rgba(255,255,255,0.8) 100%, transparent 100%),
        radial-gradient(circle 2px at 95% 65%, rgba(255,255,255,0.6) 100%, transparent 100%);
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 30px 20px 60px;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-family: 'Patrick Hand', cursive;
      text-align: center;
      color: #fff;
      margin-bottom: 8px;
      font-size: 2.4rem;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .subtitle {
      text-align: center;
      color: rgba(255,255,255,0.9);
      margin-bottom: 30px;
      font-size: 1rem;
      line-height: 1.6;
    }

    /* Start Screen */
    .start-screen {
      background: rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      border: 2px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }

    .start-screen .intro-text {
      color: rgba(255,255,255,0.95);
      margin-bottom: 30px;
      line-height: 1.8;
      text-align: left;
      font-size: 1rem;
    }

    .start-screen .intro-text p {
      margin-bottom: 16px;
    }

    .start-screen .intro-text p:last-child {
      margin-bottom: 0;
    }

    .highlight-box {
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      border-left: 4px solid #ffd93d;
    }

    .highlight-box strong {
      color: #ffd93d;
    }

    .time-note {
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 24px;
      color: #fff;
      font-size: 0.95rem;
    }

    /* Order ID Section */
    .order-section {
      background: rgba(0,0,0,0.15);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: left;
    }

    .order-section label {
      display: block;
      margin-bottom: 8px;
      color: #ffd93d;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .order-input {
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      font-family: inherit;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      margin-bottom: 8px;
      transition: border-color 0.2s;
    }

    .order-input:focus {
      outline: none;
      border-color: #ffd93d;
    }

    .order-input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .order-hint {
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
      margin: 0;
    }

    .btn-start {
      background: linear-gradient(135deg, #ffd93d 0%, #f9a825 100%);
      color: #5a67d8;
      border: none;
      padding: 16px 48px;
      font-size: 1.1rem;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      border-radius: 30px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 20px;
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 217, 61, 0.4);
    }

    /* Form Area */
    .form-area {
      display: none;
    }

    .form-area.active {
      display: block;
    }

    /* Previous Answers */
    .previous-answers {
      margin-bottom: 24px;
    }

    .previous-answers h3 {
      color: #ffd93d;
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .previous-answers .helper-text {
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .answer-pair {
      background: rgba(255,255,255,0.1);
      border-left: 4px solid #ffd93d;
      padding: 12px 16px;
      margin-bottom: 10px;
      border-radius: 0 12px 12px 0;
    }

    .answer-pair .question {
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .answer-pair .answer {
      color: rgba(255,255,255,0.95);
      font-size: 0.95rem;
    }

    .no-answers {
      color: rgba(255,255,255,0.5);
      font-style: italic;
      font-size: 0.9rem;
    }

    /* Current Question */
    .current-question {
      background: rgba(255,255,255,0.15);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }

    .current-question-header {
      color: #ffd93d;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .current-question-hint {
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
      margin-bottom: 16px;
    }

    .question-label {
      color: #fff;
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .answer-input {
      width: 100%;
      min-height: 140px;
      background: rgba(0,0,0,0.2);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 14px;
      padding: 16px;
      font-size: 1rem;
      color: #fff;
      resize: vertical;
      font-family: inherit;
      line-height: 1.6;
    }

    .answer-input:focus {
      outline: none;
      border-color: #ffd93d;
      box-shadow: 0 0 0 2px rgba(255, 217, 61, 0.2);
    }

    .answer-input::placeholder {
      color: rgba(255,255,255,0.4);
    }

    .char-hint {
      color: rgba(255,255,255,0.5);
      font-size: 0.8rem;
      margin-top: 8px;
      font-style: italic;
    }

    .btn-next {
      background: linear-gradient(135deg, #ffd93d 0%, #f9a825 100%);
      color: #5a67d8;
      border: none;
      padding: 14px 36px;
      font-size: 1rem;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-next:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 217, 61, 0.4);
    }

    .btn-next:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Summary Screen */
    .summary-screen {
      display: none;
    }

    .summary-screen.active {
      display: block;
    }

    .summary-screen h2 {
      font-family: 'Patrick Hand', cursive;
      color: #fff;
      margin-bottom: 16px;
      font-size: 1.8rem;
    }

    .summary-screen .body-text {
      color: rgba(255,255,255,0.9);
      line-height: 1.8;
      margin-bottom: 24px;
      font-size: 1rem;
    }

    .summary-content {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      max-height: 350px;
      overflow-y: auto;
    }

    .summary-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    .summary-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .summary-item .q {
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .summary-item .a {
      color: rgba(255,255,255,0.95);
    }

    .btn-generate {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 18px 48px;
      font-size: 1.1rem;
      font-weight: 700;
      font-family: 'Nunito', sans-serif;
      border-radius: 30px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-generate:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
    }

    .btn-generate:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Result Screen */
    .result-screen {
      display: none;
    }

    .result-screen.active {
      display: block;
    }

    .result-screen h2 {
      font-family: 'Patrick Hand', cursive;
      color: #fff;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    .result-content {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 24px;
      white-space: pre-wrap;
      line-height: 1.8;
      font-size: 1.05rem;
      color: rgba(255,255,255,0.95);
      margin-bottom: 20px;
      max-height: 500px;
      overflow-y: auto;
    }

    .result-note {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
      font-style: italic;
      margin-bottom: 20px;
    }

    .btn-restart {
      background: transparent;
      color: #ffd93d;
      border: 2px solid #ffd93d;
      padding: 12px 30px;
      font-size: 0.95rem;
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-restart:hover {
      background: #ffd93d;
      color: #5a67d8;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.7);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: #ffd93d;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress indicator */
    .progress {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }

    .progress-dot.completed {
      background: #48bb78;
    }

    .progress-dot.current {
      background: #ffd93d;
      box-shadow: 0 0 10px rgba(255, 217, 61, 0.5);
    }

    /* Error state */
    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid rgba(239, 68, 68, 0.4);
      color: #fca5a5;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    /* Footer */
    .footer-accent {
      width: 100%;
      height: 100px;
      background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.3) 100%);
      position: relative;
      margin-top: 40px;
    }

    .footer-accent::before {
      content: '';
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: linear-gradient(90deg, transparent, #ffd93d, transparent);
      border-radius: 2px;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.9rem;
      }

      .container {
        padding: 20px 15px 40px;
      }

      .start-screen {
        padding: 25px;
      }

      .progress-dot {
        width: 8px;
        height: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Decorative header with stars -->
  <div class="wave-header"></div>

  <div class="container">
    <h1>Custom Flash Cards for Your Child</h1>
    <p class="subtitle">Learning tools designed specifically for YOUR kid</p>

    <!-- Start Screen -->
    <div id="startScreen" class="start-screen">
      <div class="intro-text">
        <p>These aren't generic flash cards. We're going to create a set designed specifically for YOUR child - using their interests, addressing exactly where they're struggling, and matching how they learn best.</p>

        <div class="highlight-box">
          <strong>How this works:</strong> I'll ask you questions about your child - who they are, what they're working on, how they learn, and what they love. Then I'll create 20-30 custom flash cards just for them.
        </div>

        <p>A child who loves dinosaurs learns multiplication differently than one who loves soccer. A visual learner needs different cards than a hands-on learner. We'll get specific.</p>
      </div>

      <div class="time-note">
        This takes about 10-15 minutes. The more details you share, the more personalized the cards will be!
      </div>

      <!-- Order ID Section -->
      <div class="order-section" id="orderSection">
        <label for="orderIdInput">Etsy Order ID</label>
        <input type="text" id="orderIdInput" class="order-input"
               placeholder="Enter your Etsy Order ID (e.g., 1234567890)"
               maxlength="20" minlength="4" required>
        <p class="order-hint">You can find this in your Etsy purchase confirmation email</p>
      </div>

      <button class="btn-start" onclick="startSession()">Let's Create Custom Cards!</button>
    </div>

    <!-- Form Area -->
    <div id="formArea" class="form-area">
      <div id="progress" class="progress"></div>

      <div id="previousAnswers" class="previous-answers">
        <h3>What you've shared about your child</h3>
        <p class="helper-text">Everything you share helps us create cards that feel like they were made just for your kid.</p>
        <div id="answersList"></div>
      </div>

      <div id="currentQuestion" class="current-question">
        <div class="current-question-header">Tell me more</div>
        <div class="current-question-hint">The more specific you are, the better the cards will fit your child.</div>
        <div id="questionLabel" class="question-label"></div>
        <textarea
          id="answerInput"
          class="answer-input"
          placeholder="Share as much as you can - specific details help us create better cards..."
          onkeydown="handleKeyDown(event)"
        ></textarea>
        <p class="char-hint">Press Cmd+Enter to submit</p>
        <button id="nextBtn" class="btn-next" onclick="submitAnswer()">Continue</button>
      </div>

      <div id="loadingQuestion" class="loading hidden">
        <div class="spinner"></div>
        <p>Getting to know your child better...</p>
      </div>
    </div>

    <!-- Summary Screen -->
    <div id="summaryScreen" class="summary-screen">
      <h2>I've got a great picture of your child!</h2>
      <p class="body-text">Based on everything you've shared, I'm ready to create custom flash cards designed specifically for them. These won't be generic - they'll use their interests and address exactly where they need help.</p>
      <div id="summaryContent" class="summary-content"></div>
      <button class="btn-generate" onclick="generateMessage()">Create My Custom Flash Cards!</button>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="result-screen">
      <h2>Your custom flash cards are ready!</h2>
      <div id="resultContent" class="result-content"></div>
      <p class="result-note">You'll receive these as a printable PDF. For now, this is a preview of the generated content.</p>
      <button class="btn-restart" onclick="restart()">Create Another Set</button>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay" class="error hidden"></div>
  </div>

  <!-- Footer accent -->
  <div class="footer-accent"></div>

  <script>
    const API_BASE = '/api/thought-chat';

    // Get orderId from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const urlOrderId = urlParams.get('orderId');

    let sessionId = null;
    let orderId = null;
    let currentQuestion = '';
    let answers = [];
    let questionCount = 0;

    // Pre-fill orderId if provided in URL
    window.onload = function() {
      if (urlOrderId) {
        document.getElementById('orderIdInput').value = urlOrderId;
      }
    };

    async function startSession() {
      const orderInput = document.getElementById('orderIdInput');
      orderId = orderInput.value.trim();

      if (!orderId || orderId.length < 4) {
        showError('Please enter a valid Etsy Order ID (at least 4 characters)');
        return;
      }

      hideError();
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('formArea').classList.add('active');
      showLoading(true);

      try {
        const response = await fetch(`${API_BASE}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: 'flash_cards', orderId: orderId })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to start session');
        }

        const data = await response.json();
        sessionId = data.sessionId;
        orderId = data.orderId || orderId;
        currentQuestion = data.firstAssistantMessage || data.message || '';
        questionCount = 1;

        showLoading(false);
        displayQuestion();
        updateProgress();

      } catch (err) {
        showError(err.message);
        showLoading(false);
      }
    }

    function displayQuestion() {
      document.getElementById('questionLabel').textContent = currentQuestion;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
      document.getElementById('currentQuestion').classList.remove('hidden');
      updateAnswersList();
    }

    function updateAnswersList() {
      const list = document.getElementById('answersList');

      if (answers.length === 0) {
        list.innerHTML = '<p class="no-answers">Your previous answers will appear here as you progress.</p>';
        return;
      }

      list.innerHTML = answers.map((item, i) => `
        <div class="answer-pair">
          <div class="question">${escapeHtml(item.question)}</div>
          <div class="answer">${escapeHtml(item.answer)}</div>
        </div>
      `).join('');
    }

    function updateProgress() {
      const progress = document.getElementById('progress');
      const maxDots = 7; // ~7 exchanges for 10-15 min experience

      let dots = '';
      for (let i = 0; i < maxDots; i++) {
        if (i < questionCount - 1) {
          dots += '<div class="progress-dot completed"></div>';
        } else if (i === questionCount - 1) {
          dots += '<div class="progress-dot current"></div>';
        } else {
          dots += '<div class="progress-dot"></div>';
        }
      }
      progress.innerHTML = dots;
    }

    async function submitAnswer() {
      const input = document.getElementById('answerInput');
      const answer = input.value.trim();

      if (!answer) return;

      hideError();
      answers.push({ question: currentQuestion, answer: answer });

      document.getElementById('currentQuestion').classList.add('hidden');
      showLoading(true);

      try {
        const response = await fetch(`${API_BASE}/continue`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, userMessage: answer })
        });

        if (!response.ok) throw new Error('Failed to continue session');

        const data = await response.json();

        if (data.status === 'ready_for_generation') {
          showLoading(false);
          document.getElementById('formArea').classList.remove('active');
          showSummary();
        } else {
          currentQuestion = data.assistantMessage || data.message || '';
          questionCount++;
          showLoading(false);
          displayQuestion();
          updateProgress();
        }

      } catch (err) {
        showError(err.message);
        showLoading(false);
        document.getElementById('currentQuestion').classList.remove('hidden');
      }
    }

    function showSummary() {
      const content = document.getElementById('summaryContent');
      content.innerHTML = answers.map(item => `
        <div class="summary-item">
          <div class="q">${escapeHtml(item.question)}</div>
          <div class="a">${escapeHtml(item.answer)}</div>
        </div>
      `).join('');

      document.getElementById('summaryScreen').classList.add('active');
    }

    async function generateMessage() {
      hideError();
      document.getElementById('summaryScreen').classList.remove('active');
      document.getElementById('formArea').classList.add('active');
      showLoading(true);
      document.getElementById('previousAnswers').classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, orderId })
        });

        if (!response.ok) throw new Error('Failed to generate flash cards');

        const data = await response.json();

        showLoading(false);
        document.getElementById('formArea').classList.remove('active');
        showResult(data.output);

      } catch (err) {
        showError(err.message);
        showLoading(false);
        document.getElementById('summaryScreen').classList.add('active');
        document.getElementById('formArea').classList.remove('active');
      }
    }

    function showResult(output) {
      let content = '';

      if (typeof output === 'string') {
        content = output;
      } else if (typeof output === 'object') {
        if (output.summary) {
          content = output.summary;
        } else if (output.pdfPath) {
          content = `Your Custom Flash Cards have been generated!\n\nPDF File: ${output.pdfPath}\n\n`;
          if (output.cards) {
            content += `Total cards: ${output.cards.length}\n\n`;
            content += JSON.stringify(output.cards, null, 2);
          }
        } else {
          content = JSON.stringify(output, null, 2);
        }
      }

      document.getElementById('resultContent').textContent = content;
      document.getElementById('resultScreen').classList.add('active');
    }

    function restart() {
      sessionId = null;
      currentQuestion = '';
      answers = [];
      questionCount = 0;

      document.getElementById('resultScreen').classList.remove('active');
      document.getElementById('summaryScreen').classList.remove('active');
      document.getElementById('formArea').classList.remove('active');
      document.getElementById('previousAnswers').classList.remove('hidden');
      document.getElementById('startScreen').style.display = 'block';
      hideError();
    }

    function showLoading(show) {
      document.getElementById('loadingQuestion').classList.toggle('hidden', !show);
      document.getElementById('nextBtn').disabled = show;
    }

    function showError(message) {
      const el = document.getElementById('errorDisplay');
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('errorDisplay').classList.add('hidden');
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && event.metaKey) {
        submitAnswer();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
