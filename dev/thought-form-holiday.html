<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holiday Relationship Reset | Personalized Reflection Guide</title>
  <meta name="description" content="Navigate family dynamics with clarity. A guided reflection to help you prepare for holiday gatherings and set healthy boundaries.">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,500;1,400&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Lora', Georgia, serif;
      background: linear-gradient(135deg, #2d5a4a 0%, #1a3d32 50%, #0f2620 100%);
      min-height: 100vh;
      color: #fff;
    }

    /* Soft pine branch decorative header */
    .pine-header {
      width: 100%;
      height: 120px;
      background: linear-gradient(180deg, #1a3d32 0%, #2d5a4a 60%, transparent 100%);
      position: relative;
      overflow: hidden;
    }

    .pine-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 80px;
      background:
        radial-gradient(ellipse 100px 60px at 5% 0%, #3d7a64 60%, transparent 61%),
        radial-gradient(ellipse 120px 70px at 25% 0%, #2d5a4a 60%, transparent 61%),
        radial-gradient(ellipse 90px 55px at 50% 0%, #3d7a64 60%, transparent 61%),
        radial-gradient(ellipse 110px 65px at 75% 0%, #2d5a4a 60%, transparent 61%),
        radial-gradient(ellipse 95px 58px at 95% 0%, #3d7a64 60%, transparent 61%);
    }

    /* Subtle berries */
    .pine-header::after {
      content: '';
      position: absolute;
      top: 30px;
      left: 0;
      right: 0;
      height: 40px;
      background:
        radial-gradient(circle 5px at 15% 50%, #c94c4c 90%, transparent 91%),
        radial-gradient(circle 4px at 35% 30%, #c94c4c 90%, transparent 91%),
        radial-gradient(circle 5px at 55% 60%, #c94c4c 90%, transparent 91%),
        radial-gradient(circle 4px at 70% 40%, #c94c4c 90%, transparent 91%),
        radial-gradient(circle 5px at 85% 50%, #c94c4c 90%, transparent 91%);
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 30px 20px 60px;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-family: 'Playfair Display', Georgia, serif;
      text-align: center;
      color: #e8d5b7;
      margin-bottom: 8px;
      font-size: 2.2rem;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .subtitle {
      text-align: center;
      color: rgba(255,255,255,0.75);
      margin-bottom: 30px;
      font-size: 1rem;
      line-height: 1.6;
      font-style: italic;
    }

    /* Start Screen */
    .start-screen {
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      border: 1px solid rgba(232,213,183,0.15);
      backdrop-filter: blur(10px);
    }

    .start-screen .intro-text {
      color: rgba(255,255,255,0.85);
      margin-bottom: 30px;
      line-height: 1.8;
      text-align: left;
      font-size: 1rem;
    }

    .start-screen .intro-text p {
      margin-bottom: 16px;
    }

    .start-screen .intro-text p:last-child {
      margin-bottom: 0;
    }

    /* Order ID Section */
    .order-section {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: left;
    }

    .order-section label {
      display: block;
      margin-bottom: 8px;
      color: #e8d5b7;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .order-input {
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      font-family: inherit;
      border: 1px solid rgba(232,213,183,0.3);
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      margin-bottom: 8px;
      transition: border-color 0.2s;
    }

    .order-input:focus {
      outline: none;
      border-color: #e8d5b7;
    }

    .order-input::placeholder {
      color: rgba(255,255,255,0.4);
    }

    .order-hint {
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      margin: 0;
    }

    .btn-start {
      background: linear-gradient(135deg, #c94c4c 0%, #a33a3a 100%);
      color: white;
      border: none;
      padding: 16px 48px;
      font-size: 1.1rem;
      font-family: 'Lora', Georgia, serif;
      border-radius: 30px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 20px;
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(201, 76, 76, 0.4);
    }

    /* Form Area */
    .form-area {
      display: none;
    }

    .form-area.active {
      display: block;
    }

    /* Previous Answers */
    .previous-answers {
      margin-bottom: 24px;
    }

    .previous-answers h3 {
      color: #e8d5b7;
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .previous-answers .helper-text {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .answer-pair {
      background: rgba(255,255,255,0.05);
      border-left: 3px solid #4a9b7f;
      padding: 12px 16px;
      margin-bottom: 10px;
      border-radius: 0 10px 10px 0;
    }

    .answer-pair .question {
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .answer-pair .answer {
      color: rgba(255,255,255,0.9);
      font-size: 0.95rem;
    }

    .no-answers {
      color: rgba(255,255,255,0.4);
      font-style: italic;
      font-size: 0.9rem;
    }

    /* Current Question */
    .current-question {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(232,213,183,0.1);
      border-radius: 16px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }

    .current-question-header {
      color: #4a9b7f;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .current-question-hint {
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      margin-bottom: 16px;
    }

    .question-label {
      color: #fff;
      font-size: 1.15rem;
      font-weight: 500;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .answer-input {
      width: 100%;
      min-height: 120px;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(232,213,183,0.2);
      border-radius: 12px;
      padding: 16px;
      font-size: 1rem;
      color: #fff;
      resize: vertical;
      font-family: inherit;
    }

    .answer-input:focus {
      outline: none;
      border-color: #4a9b7f;
      box-shadow: 0 0 0 2px rgba(74, 155, 127, 0.15);
    }

    .answer-input::placeholder {
      color: rgba(255,255,255,0.4);
    }

    .btn-next {
      background: linear-gradient(135deg, #c94c4c 0%, #a33a3a 100%);
      color: white;
      border: none;
      padding: 14px 36px;
      font-size: 1rem;
      font-family: 'Lora', Georgia, serif;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-next:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(201, 76, 76, 0.4);
    }

    .btn-next:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Summary Screen */
    .summary-screen {
      display: none;
    }

    .summary-screen.active {
      display: block;
    }

    .summary-screen h2 {
      font-family: 'Playfair Display', Georgia, serif;
      color: #e8d5b7;
      margin-bottom: 16px;
    }

    .summary-screen .body-text {
      color: rgba(255,255,255,0.8);
      line-height: 1.8;
      margin-bottom: 24px;
      font-size: 1rem;
    }

    .summary-content {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(232,213,183,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      max-height: 300px;
      overflow-y: auto;
    }

    .summary-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .summary-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .summary-item .q {
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .summary-item .a {
      color: rgba(255,255,255,0.9);
    }

    .btn-generate {
      background: linear-gradient(135deg, #4a9b7f 0%, #357a61 100%);
      color: white;
      border: none;
      padding: 18px 48px;
      font-size: 1.1rem;
      font-weight: 600;
      font-family: 'Lora', Georgia, serif;
      border-radius: 30px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-generate:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(74, 155, 127, 0.4);
    }

    .btn-generate:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Result Screen */
    .result-screen {
      display: none;
    }

    .result-screen.active {
      display: block;
    }

    .result-screen h2 {
      font-family: 'Playfair Display', Georgia, serif;
      color: #e8d5b7;
      margin-bottom: 20px;
    }

    .result-content {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(232,213,183,0.1);
      border-radius: 12px;
      padding: 24px;
      white-space: pre-wrap;
      line-height: 1.8;
      font-size: 1.05rem;
      color: rgba(255,255,255,0.9);
      margin-bottom: 20px;
    }

    .result-note {
      color: rgba(255,255,255,0.5);
      font-size: 0.9rem;
      font-style: italic;
      margin-bottom: 20px;
    }

    .btn-restart {
      background: transparent;
      color: #e8d5b7;
      border: 2px solid #e8d5b7;
      padding: 12px 30px;
      font-size: 0.95rem;
      font-family: 'Lora', Georgia, serif;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-restart:hover {
      background: #e8d5b7;
      color: #1a3d32;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.6);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #4a9b7f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress indicator */
    .progress {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }

    .progress-dot.completed {
      background: #4a9b7f;
    }

    .progress-dot.current {
      background: #c94c4c;
      box-shadow: 0 0 10px rgba(201, 76, 76, 0.5);
    }

    /* Error state */
    .error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    /* Warm footer with holly accent */
    .footer-accent {
      width: 100%;
      height: 100px;
      background: linear-gradient(180deg, transparent 0%, #0f2620 100%);
      position: relative;
      margin-top: 40px;
    }

    .footer-accent::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 50px;
      background:
        radial-gradient(ellipse 25px 18px at 25% 60%, #3d7a64 70%, transparent 71%),
        radial-gradient(ellipse 25px 18px at 75% 60%, #3d7a64 70%, transparent 71%),
        radial-gradient(circle 6px at 50% 35%, #c94c4c 90%, transparent 91%),
        radial-gradient(circle 5px at 45% 45%, #c94c4c 90%, transparent 91%),
        radial-gradient(circle 5px at 55% 45%, #c94c4c 90%, transparent 91%);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.7rem;
      }

      .container {
        padding: 20px 15px 40px;
      }

      .start-screen {
        padding: 25px;
      }
    }
  </style>
</head>
<body>
  <!-- Decorative pine header -->
  <div class="pine-header"></div>

  <div class="container">
    <h1>Holiday Relationship Reset</h1>
    <p class="subtitle">Navigate family dynamics with clarity and intention</p>

    <!-- Start Screen -->
    <div id="startScreen" class="start-screen">
      <div class="intro-text">
        <p>Holiday gatherings can bring up old patterns, unspoken expectations, and little comments that stay with you.</p>
        <p>This guided reflection helps you name what's really happening, what you're afraid of, and what kind of holiday would feel more peaceful — without telling you what to do or judging how you feel.</p>
      </div>

      <!-- Order ID Section -->
      <div class="order-section" id="orderSection">
        <label for="orderIdInput">Etsy Order ID</label>
        <input type="text" id="orderIdInput" class="order-input"
               placeholder="Enter your Etsy Order ID (e.g., 1234567890)"
               maxlength="20" minlength="4" required>
        <p class="order-hint">You can find this in your Etsy purchase confirmation email</p>
      </div>

      <button class="btn-start" onclick="startSession()">Begin Your Reflection</button>
    </div>

    <!-- Form Area -->
    <div id="formArea" class="form-area">
      <div id="progress" class="progress"></div>

      <div id="previousAnswers" class="previous-answers">
        <h3>What you've shared so far</h3>
        <p class="helper-text">As you go, you'll see your earlier answers here. There are no "right" answers — we're just collecting the details that will help shape your planner.</p>
        <div id="answersList"></div>
      </div>

      <div id="currentQuestion" class="current-question">
        <div class="current-question-header">Current question</div>
        <div class="current-question-hint">Your next question may change slightly based on what you've already shared.</div>
        <div id="questionLabel" class="question-label"></div>
        <textarea
          id="answerInput"
          class="answer-input"
          placeholder="Type your answer here..."
          onkeydown="handleKeyDown(event)"
        ></textarea>
        <button id="nextBtn" class="btn-next" onclick="submitAnswer()">Next</button>
      </div>

      <div id="loadingQuestion" class="loading hidden">
        <div class="spinner"></div>
        <p>Reflecting...</p>
      </div>
    </div>

    <!-- Summary Screen -->
    <div id="summaryScreen" class="summary-screen">
      <h2>You've reached the end of the questions</h2>
      <p class="body-text">You've just taken time to name what's really happening for you around the holidays — the patterns, the pressure, and what you actually want this season to feel like.</p>
      <p class="body-text">When you click below, we'll use what you've shared to create a Holiday Reset guide that reflects your situation and priorities.</p>
      <div id="summaryContent" class="summary-content"></div>
      <button class="btn-generate" onclick="generateMessage()">Generate Your Holiday Guide</button>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="result-screen">
      <h2>Your Holiday Reset guide is ready</h2>
      <div id="resultContent" class="result-content"></div>
      <p class="result-note">You'll receive this as your final digital file. For now, this is a preview of the generated content.</p>
      <button class="btn-restart" onclick="restart()">Start Over</button>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay" class="error hidden"></div>
  </div>

  <!-- Footer accent -->
  <div class="footer-accent"></div>

  <script>
    const API_BASE = '/api/thought-chat';

    // Get orderId from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const urlOrderId = urlParams.get('orderId');

    let sessionId = null;
    let orderId = null;
    let currentQuestion = '';
    let answers = [];
    let questionCount = 0;

    // Pre-fill orderId if provided in URL
    window.onload = function() {
      if (urlOrderId) {
        document.getElementById('orderIdInput').value = urlOrderId;
      }
    };

    async function startSession() {
      const orderInput = document.getElementById('orderIdInput');
      orderId = orderInput.value.trim();

      if (!orderId || orderId.length < 4) {
        showError('Please enter a valid Etsy Order ID (at least 4 characters)');
        return;
      }

      hideError();
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('formArea').classList.add('active');
      showLoading(true);

      try {
        const response = await fetch(`${API_BASE}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: 'holiday_reset', orderId: orderId })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to start session');
        }

        const data = await response.json();
        sessionId = data.sessionId;
        orderId = data.orderId || orderId;
        currentQuestion = data.firstAssistantMessage || data.message || '';
        questionCount = 1;

        showLoading(false);
        displayQuestion();
        updateProgress();

      } catch (err) {
        showError(err.message);
        showLoading(false);
      }
    }

    function displayQuestion() {
      document.getElementById('questionLabel').textContent = currentQuestion;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
      document.getElementById('currentQuestion').classList.remove('hidden');
      updateAnswersList();
    }

    function updateAnswersList() {
      const list = document.getElementById('answersList');

      if (answers.length === 0) {
        list.innerHTML = '<p class="no-answers">Your previous answers will appear here.</p>';
        return;
      }

      list.innerHTML = answers.map((item, i) => `
        <div class="answer-pair">
          <div class="question">${escapeHtml(item.question)}</div>
          <div class="answer">${escapeHtml(item.answer)}</div>
        </div>
      `).join('');
    }

    function updateProgress() {
      const progress = document.getElementById('progress');
      const maxDots = 10;

      let dots = '';
      for (let i = 0; i < maxDots; i++) {
        if (i < questionCount - 1) {
          dots += '<div class="progress-dot completed"></div>';
        } else if (i === questionCount - 1) {
          dots += '<div class="progress-dot current"></div>';
        } else {
          dots += '<div class="progress-dot"></div>';
        }
      }
      progress.innerHTML = dots;
    }

    async function submitAnswer() {
      const input = document.getElementById('answerInput');
      const answer = input.value.trim();

      if (!answer) return;

      hideError();
      answers.push({ question: currentQuestion, answer: answer });

      document.getElementById('currentQuestion').classList.add('hidden');
      showLoading(true);

      try {
        const response = await fetch(`${API_BASE}/continue`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, userMessage: answer })
        });

        if (!response.ok) throw new Error('Failed to continue session');

        const data = await response.json();

        if (data.status === 'ready_for_generation') {
          showLoading(false);
          document.getElementById('formArea').classList.remove('active');
          showSummary();
        } else {
          currentQuestion = data.assistantMessage || data.message || '';
          questionCount++;
          showLoading(false);
          displayQuestion();
          updateProgress();
        }

      } catch (err) {
        showError(err.message);
        showLoading(false);
        document.getElementById('currentQuestion').classList.remove('hidden');
      }
    }

    function showSummary() {
      const content = document.getElementById('summaryContent');
      content.innerHTML = answers.map(item => `
        <div class="summary-item">
          <div class="q">${escapeHtml(item.question)}</div>
          <div class="a">${escapeHtml(item.answer)}</div>
        </div>
      `).join('');

      document.getElementById('summaryScreen').classList.add('active');
    }

    async function generateMessage() {
      hideError();
      document.getElementById('summaryScreen').classList.remove('active');
      document.getElementById('formArea').classList.add('active');
      showLoading(true);
      document.getElementById('previousAnswers').classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, orderId })
        });

        if (!response.ok) throw new Error('Failed to generate planner');

        const data = await response.json();

        showLoading(false);
        document.getElementById('formArea').classList.remove('active');
        showResult(data.output);

      } catch (err) {
        showError(err.message);
        showLoading(false);
        document.getElementById('summaryScreen').classList.add('active');
        document.getElementById('formArea').classList.remove('active');
      }
    }

    function showResult(output) {
      let content = '';

      if (typeof output === 'string') {
        content = output;
      } else if (typeof output === 'object') {
        if (output.summary) {
          content = output.summary;
        } else if (output.pdfPath) {
          content = `Your Holiday Reset guide has been generated.\n\nPDF File: ${output.pdfPath}\n\n`;
          if (output.sections) {
            content += JSON.stringify(output.sections, null, 2);
          }
        } else {
          content = JSON.stringify(output, null, 2);
        }
      }

      document.getElementById('resultContent').textContent = content;
      document.getElementById('resultScreen').classList.add('active');
    }

    function restart() {
      sessionId = null;
      currentQuestion = '';
      answers = [];
      questionCount = 0;

      document.getElementById('resultScreen').classList.remove('active');
      document.getElementById('summaryScreen').classList.remove('active');
      document.getElementById('formArea').classList.remove('active');
      document.getElementById('previousAnswers').classList.remove('hidden');
      document.getElementById('startScreen').style.display = 'block';
      hideError();
    }

    function showLoading(show) {
      document.getElementById('loadingQuestion').classList.toggle('hidden', !show);
      document.getElementById('nextBtn').disabled = show;
    }

    function showError(message) {
      const el = document.getElementById('errorDisplay');
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('errorDisplay').classList.add('hidden');
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && event.metaKey) {
        submitAnswer();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
