<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holiday Relationship Reset Thought Organizer</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a2f1a 0%, #0d1f0d 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: #e8e8e8;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #fff;
      margin-bottom: 8px;
      font-size: 1.8rem;
    }

    .subtitle {
      text-align: center;
      color: #aaa;
      margin-bottom: 30px;
      font-size: 1rem;
      line-height: 1.5;
    }

    /* Start Screen */
    .start-screen {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
    }

    .start-screen .intro-text {
      color: #ccc;
      margin-bottom: 30px;
      line-height: 1.7;
      text-align: left;
      font-size: 0.95rem;
    }

    .start-screen .intro-text p {
      margin-bottom: 16px;
    }

    .start-screen .intro-text p:last-child {
      margin-bottom: 0;
    }

    .btn-start {
      background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
      color: white;
      border: none;
      padding: 16px 48px;
      font-size: 1.1rem;
      border-radius: 30px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 20px;
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(196, 30, 58, 0.4);
    }

    /* Form Area */
    .form-area {
      display: none;
    }

    .form-area.active {
      display: block;
    }

    /* Previous Answers */
    .previous-answers {
      margin-bottom: 24px;
    }

    .previous-answers h3 {
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .previous-answers .helper-text {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .answer-pair {
      background: rgba(255,255,255,0.03);
      border-left: 3px solid #2d6a4f;
      padding: 12px 16px;
      margin-bottom: 10px;
      border-radius: 0 8px 8px 0;
    }

    .answer-pair .question {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .answer-pair .answer {
      color: #e8e8e8;
      font-size: 0.95rem;
    }

    .no-answers {
      color: #666;
      font-style: italic;
      font-size: 0.9rem;
    }

    /* Current Question */
    .current-question {
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 30px;
    }

    .current-question-header {
      color: #c41e3a;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .current-question-hint {
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 16px;
    }

    .question-label {
      color: #fff;
      font-size: 1.15rem;
      font-weight: 500;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .answer-input {
      width: 100%;
      min-height: 120px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      font-size: 1rem;
      color: #e8e8e8;
      resize: vertical;
      font-family: inherit;
    }

    .answer-input:focus {
      outline: none;
      border-color: #2d6a4f;
    }

    .answer-input::placeholder {
      color: #666;
    }

    .btn-next {
      background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
      color: white;
      border: none;
      padding: 14px 36px;
      font-size: 1rem;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-next:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(196, 30, 58, 0.4);
    }

    .btn-next:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Summary Screen */
    .summary-screen {
      display: none;
    }

    .summary-screen.active {
      display: block;
    }

    .summary-screen h2 {
      color: #2d6a4f;
      margin-bottom: 16px;
    }

    .summary-screen .body-text {
      color: #ccc;
      line-height: 1.7;
      margin-bottom: 24px;
      font-size: 0.95rem;
    }

    .summary-content {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      max-height: 300px;
      overflow-y: auto;
    }

    .summary-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .summary-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .summary-item .q {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .summary-item .a {
      color: #e8e8e8;
    }

    .btn-generate {
      background: linear-gradient(135deg, #2d6a4f 0%, #1b4332 100%);
      color: white;
      border: none;
      padding: 18px 48px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 30px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-generate:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(45, 106, 79, 0.4);
    }

    .btn-generate:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Result Screen */
    .result-screen {
      display: none;
    }

    .result-screen.active {
      display: block;
    }

    .result-screen h2 {
      color: #2d6a4f;
      margin-bottom: 20px;
    }

    .result-content {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 24px;
      white-space: pre-wrap;
      line-height: 1.7;
      font-size: 1.05rem;
      margin-bottom: 20px;
    }

    .result-note {
      color: #888;
      font-size: 0.85rem;
      font-style: italic;
      margin-bottom: 20px;
    }

    .btn-restart {
      background: rgba(255,255,255,0.1);
      color: #e8e8e8;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 12px 30px;
      font-size: 0.95rem;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-restart:hover {
      background: rgba(255,255,255,0.15);
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #c41e3a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress indicator */
    .progress {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }

    .progress-dot.completed {
      background: #2d6a4f;
    }

    .progress-dot.current {
      background: #c41e3a;
      box-shadow: 0 0 10px rgba(196, 30, 58, 0.6);
    }

    /* Error state */
    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Holiday Relationship Reset Thought Organizer</h1>
    <p class="subtitle">A calm space to sort through what's actually happening around the holidays — so you can see it more clearly.</p>

    <!-- Start Screen -->
    <div id="startScreen" class="start-screen">
      <div class="intro-text">
        <p>Holiday gatherings can bring up old patterns, unspoken expectations, and little comments that stay with you.</p>
        <p>This guided question flow helps you name what's really happening, what you're afraid of, and what kind of holiday would feel more peaceful and manageable — without telling you what to do or judging how you feel.</p>
      </div>

      <!-- Order ID Section -->
      <div class="order-section" id="orderSection">
        <label for="orderIdInput" style="display: block; margin-bottom: 8px; color: #fff; font-weight: 500;">Etsy Order ID</label>
        <input type="text" id="orderIdInput"
               placeholder="Enter your Etsy Order ID (e.g., 1234567890)"
               style="width: 100%; padding: 12px 16px; font-size: 1rem; border: 1px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; margin-bottom: 8px;"
               maxlength="20" minlength="4" required>
        <p style="color: #888; font-size: 0.85rem; margin: 0 0 20px 0;">You can find this in your Etsy purchase confirmation email or order history</p>
      </div>

      <button class="btn-start" onclick="startSession()">Begin the questions</button>
    </div>

    <!-- Form Area -->
    <div id="formArea" class="form-area">
      <div id="progress" class="progress"></div>

      <div id="previousAnswers" class="previous-answers">
        <h3>What you've shared so far</h3>
        <p class="helper-text">As you go, you'll see your earlier answers here. There are no "right" answers — we're just collecting the details that will help shape your planner.</p>
        <div id="answersList"></div>
      </div>

      <div id="currentQuestion" class="current-question">
        <div class="current-question-header">Current question</div>
        <div class="current-question-hint">Your next question may change slightly based on what you've already shared.</div>
        <div id="questionLabel" class="question-label"></div>
        <textarea
          id="answerInput"
          class="answer-input"
          placeholder="Type your answer here..."
          onkeydown="handleKeyDown(event)"
        ></textarea>
        <button id="nextBtn" class="btn-next" onclick="submitAnswer()">Next</button>
      </div>

      <div id="loadingQuestion" class="loading hidden">
        <div class="spinner"></div>
        <p>Thinking...</p>
      </div>
    </div>

    <!-- Summary Screen -->
    <div id="summaryScreen" class="summary-screen">
      <h2>You've reached the end of the questions</h2>
      <p class="body-text">You've just taken time to name what's really happening for you around the holidays — the patterns, the pressure, and what you actually want this season to feel like.</p>
      <p class="body-text">When you click below, we'll use what you've shared to create a Holiday Reset planner that reflects your situation and priorities.</p>
      <div id="summaryContent" class="summary-content"></div>
      <button class="btn-generate" onclick="generateMessage()">Generate Holiday Reset planner</button>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="result-screen">
      <h2>Your Holiday Reset planner is ready (preview)</h2>
      <div id="resultContent" class="result-content"></div>
      <p class="result-note">You'll receive this as your final digital file. For now, this is a developer preview of the generated content.</p>
      <button class="btn-restart" onclick="restart()">Start Over</button>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay" class="error hidden"></div>
  </div>

  <script>
    const API_BASE = '/api/thought-chat';

    // Get orderId from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const urlOrderId = urlParams.get('orderId');

    let sessionId = null;
    let orderId = null;
    let currentQuestion = '';
    let answers = []; // Array of {question, answer} pairs
    let questionCount = 0;

    // Pre-fill orderId if provided in URL
    window.onload = function() {
      if (urlOrderId) {
        document.getElementById('orderIdInput').value = urlOrderId;
      }
    };

    async function startSession() {
      // Get orderId from input
      const orderInput = document.getElementById('orderIdInput');
      orderId = orderInput.value.trim();

      if (!orderId || orderId.length < 4) {
        showError('Please enter a valid Etsy Order ID (at least 4 characters)');
        return;
      }

      hideError();
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('formArea').classList.add('active');
      showLoading(true);

      try {
        const response = await fetch(`${API_BASE}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: 'holiday_reset', orderId: orderId })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to start session');
        }

        const data = await response.json();
        sessionId = data.sessionId;
        orderId = data.orderId || orderId; // Use sanitized orderId from server
        // Handle both possible field names
        currentQuestion = data.firstAssistantMessage || data.message || '';
        questionCount = 1;

        showLoading(false);
        displayQuestion();
        updateProgress();

      } catch (err) {
        showError(err.message);
        showLoading(false);
      }
    }

    function displayQuestion() {
      document.getElementById('questionLabel').textContent = currentQuestion;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
      document.getElementById('currentQuestion').classList.remove('hidden');

      updateAnswersList();
    }

    function updateAnswersList() {
      const list = document.getElementById('answersList');

      if (answers.length === 0) {
        list.innerHTML = '<p class="no-answers">Your previous answers will appear here.</p>';
        return;
      }

      list.innerHTML = answers.map((item, i) => `
        <div class="answer-pair">
          <div class="question">${escapeHtml(item.question)}</div>
          <div class="answer">${escapeHtml(item.answer)}</div>
        </div>
      `).join('');
    }

    function updateProgress() {
      const progress = document.getElementById('progress');
      const maxDots = 10; // Approximate max questions

      let dots = '';
      for (let i = 0; i < maxDots; i++) {
        if (i < questionCount - 1) {
          dots += '<div class="progress-dot completed"></div>';
        } else if (i === questionCount - 1) {
          dots += '<div class="progress-dot current"></div>';
        } else {
          dots += '<div class="progress-dot"></div>';
        }
      }
      progress.innerHTML = dots;
    }

    async function submitAnswer() {
      const input = document.getElementById('answerInput');
      const answer = input.value.trim();

      if (!answer) return;

      hideError();

      // Store the Q&A pair
      answers.push({ question: currentQuestion, answer: answer });

      document.getElementById('currentQuestion').classList.add('hidden');
      showLoading(true);

      try {
        const response = await fetch(`${API_BASE}/continue`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, userMessage: answer })
        });

        if (!response.ok) throw new Error('Failed to continue session');

        const data = await response.json();

        if (data.status === 'ready_for_generation') {
          // Show summary screen
          showLoading(false);
          document.getElementById('formArea').classList.remove('active');
          showSummary();
        } else {
          // Next question - handle both field names
          currentQuestion = data.assistantMessage || data.message || '';
          questionCount++;
          showLoading(false);
          displayQuestion();
          updateProgress();
        }

      } catch (err) {
        showError(err.message);
        showLoading(false);
        document.getElementById('currentQuestion').classList.remove('hidden');
      }
    }

    function showSummary() {
      const content = document.getElementById('summaryContent');
      content.innerHTML = answers.map(item => `
        <div class="summary-item">
          <div class="q">${escapeHtml(item.question)}</div>
          <div class="a">${escapeHtml(item.answer)}</div>
        </div>
      `).join('');

      document.getElementById('summaryScreen').classList.add('active');
    }

    async function generateMessage() {
      hideError();
      document.getElementById('summaryScreen').classList.remove('active');
      document.getElementById('formArea').classList.add('active');
      showLoading(true);
      document.getElementById('previousAnswers').classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, orderId })
        });

        if (!response.ok) throw new Error('Failed to generate planner');

        const data = await response.json();

        showLoading(false);
        document.getElementById('formArea').classList.remove('active');
        showResult(data.output);

      } catch (err) {
        showError(err.message);
        showLoading(false);
        document.getElementById('summaryScreen').classList.add('active');
        document.getElementById('formArea').classList.remove('active');
      }
    }

    function showResult(output) {
      // Handle different output formats
      let content = '';

      if (typeof output === 'string') {
        content = output;
      } else if (typeof output === 'object') {
        // Format the planner output nicely
        if (output.summary) {
          content = output.summary;
        } else if (output.pdfPath) {
          content = `Your Holiday Reset planner has been generated.\n\nPDF File: ${output.pdfPath}\n\n`;
          if (output.sections) {
            content += JSON.stringify(output.sections, null, 2);
          }
        } else {
          content = JSON.stringify(output, null, 2);
        }
      }

      document.getElementById('resultContent').textContent = content;
      document.getElementById('resultScreen').classList.add('active');
    }

    function restart() {
      sessionId = null;
      currentQuestion = '';
      answers = [];
      questionCount = 0;

      document.getElementById('resultScreen').classList.remove('active');
      document.getElementById('summaryScreen').classList.remove('active');
      document.getElementById('formArea').classList.remove('active');
      document.getElementById('previousAnswers').classList.remove('hidden');
      document.getElementById('startScreen').style.display = 'block';
      hideError();
    }

    function showLoading(show) {
      document.getElementById('loadingQuestion').classList.toggle('hidden', !show);
      document.getElementById('nextBtn').disabled = show;
    }

    function showError(message) {
      const el = document.getElementById('errorDisplay');
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('errorDisplay').classList.add('hidden');
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && event.metaKey) {
        submitAnswer();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
