<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Redi â€” Ready for Anything</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0A0A0A; color: #ffffff; font-family: 'Georgia', serif;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden;
        }
        .container {
            max-width: 500px; width: 100%; padding: 20px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .logo { font-size: 48px; letter-spacing: 8px; color: #00CED1; margin-top: 40px; font-variant: small-caps; }
        .tagline { font-size: 14px; color: #666; margin-top: 4px; font-style: italic; }
        .status-bar {
            display: flex; align-items: center; gap: 8px; margin-top: 20px;
            padding: 8px 16px; border-radius: 20px; background: rgba(0, 206, 209, 0.08); font-size: 13px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .status-dot.connected { background: #00CED1; animation: pulse 2s infinite; }
        .status-dot.listening { background: #00FF88; animation: pulse 1s infinite; }
        .status-dot.error { background: #FF4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .status-text { color: #888; }
        .brain-badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; background: rgba(0, 206, 209, 0.15); color: #00CED1; }
        .main-area {
            flex: 1; width: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 20px; padding: 20px 0;
        }
        .visualizer {
            width: 120px; height: 120px; border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 206, 209, 0.2) 0%, transparent 70%);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .visualizer.active { animation: breathe 3s ease-in-out infinite; }
        .visualizer-inner {
            width: 60px; height: 60px; border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 206, 209, 0.4) 0%, rgba(0, 206, 209, 0.1) 100%);
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        .transcript-area { width: 100%; max-height: 200px; overflow-y: auto; padding: 0 10px; }
        .transcript-line { padding: 6px 0; font-size: 14px; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .transcript-line.redi { color: #00CED1; }
        .transcript-line .speaker { font-size: 11px; color: #666; display: block; margin-bottom: 2px; }
        .response-area {
            width: 100%; min-height: 60px; padding: 16px;
            background: rgba(0, 206, 209, 0.05); border-radius: 12px;
            font-size: 15px; line-height: 1.5; color: #ddd;
        }
        .response-area.speaking { border: 1px solid rgba(0, 206, 209, 0.3); }
        .controls { width: 100%; display: flex; flex-direction: column; gap: 12px; padding-bottom: 30px; }
        .control-row { display: flex; gap: 12px; justify-content: center; }
        .btn {
            padding: 14px 24px; border-radius: 12px; border: none; font-family: 'Georgia', serif;
            font-size: 16px; cursor: pointer; transition: all 0.2s; flex: 1; max-width: 200px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: #00CED1; color: #000; font-weight: bold; }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }
        .btn-danger { background: rgba(255, 68, 68, 0.8); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.08); color: #aaa; }
        .btn-icon {
            width: 50px; height: 50px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 20px; flex: none; max-width: none;
        }
        .btn-icon.active { background: rgba(0, 206, 209, 0.2); color: #00CED1; }
        .btn-icon.muted { background: rgba(255, 68, 68, 0.2); color: #FF4444; }
        .mode-selector { display: flex; gap: 8px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        .mode-btn {
            padding: 8px 16px; border-radius: 20px; border: 1px solid #333;
            background: transparent; color: #888; font-size: 13px; cursor: pointer; font-family: 'Georgia', serif;
        }
        .mode-btn.selected { border-color: #00CED1; color: #00CED1; background: rgba(0, 206, 209, 0.08); }
        .screen-preview {
            width: 100%; max-height: 200px; border-radius: 8px; overflow: hidden;
            background: #111; display: none; position: relative;
        }
        .screen-preview.active { display: block; }
        .screen-preview video { width: 100%; height: auto; }
        .screen-preview .label {
            position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7);
            color: #00CED1; font-size: 11px; padding: 2px 8px; border-radius: 4px;
        }
        .settings-panel {
            width: 100%; background: rgba(255,255,255,0.03); border-radius: 12px;
            padding: 16px; margin-top: 12px; display: none;
        }
        .settings-panel.open { display: block; }
        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .setting-label { font-size: 14px; color: #aaa; }
        select {
            background: #1a1a1a; color: #fff; border: 1px solid #333;
            padding: 6px 10px; border-radius: 6px; font-family: 'Georgia', serif;
        }
        .disclaimer { font-size: 11px; color: rgba(255,255,255,0.3); text-align: center; padding: 10px; margin-top: auto; }
        .chat-input-area { width: 100%; display: none; gap: 8px; }
        .chat-input-area.visible { display: flex; }
        .chat-input {
            flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #333;
            background: #111; color: #fff; font-family: 'Georgia', serif; font-size: 14px; outline: none;
        }
        .chat-input:focus { border-color: #00CED1; }
        .chat-send {
            width: 44px; height: 44px; border-radius: 50%; background: #00CED1;
            color: #000; border: none; cursor: pointer; font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">REDI</div>
        <div class="tagline">for anything</div>

        <div style="display:flex; align-items:center; gap:8px; margin-top:12px;">
            <span style="color:#888; font-size:13px;" id="userGreeting"></span>
            <span class="brain-badge" id="creditBadge" style="display:inline; background:rgba(0,206,209,0.1); cursor:pointer;" onclick="showBuyCredits()"><span id="creditCount">--</span> credits</span>
            <button onclick="logout()" style="background:none; border:1px solid #333; color:#888; padding:4px 10px; border-radius:6px; font-size:12px; cursor:pointer; font-family:Georgia,serif;">Sign Out</button>
        </div>

        <div class="status-bar">
            <div class="status-dot" id="statusDot"></div>
            <span class="status-text" id="statusText">Disconnected</span>
            <span class="brain-badge" id="brainBadge" style="display:none"></span>
        </div>

        <div class="mode-selector" id="modeSelector">
            <button class="mode-btn selected" data-mode="voice" onclick="selectMode('voice')">&#x1F3A4; Voice</button>
            <button class="mode-btn" data-mode="screen" onclick="selectMode('screen')">&#x1F5A5;&#xFE0F; Screen + Voice</button>
            <button class="mode-btn" data-mode="observe" onclick="selectMode('observe')">&#x1F442; Always On</button>
            <button class="mode-btn" data-mode="chat" onclick="selectMode('chat')">&#x1F4AC; Chat Only</button>
        </div>

        <div class="main-area">
            <div class="screen-preview" id="screenPreview">
                <video id="screenVideo" autoplay muted></video>
                <span class="label">Screen Sharing</span>
            </div>
            <div class="visualizer" id="visualizer">
                <div class="visualizer-inner"></div>
            </div>
            <div class="response-area" id="responseArea">Press Start to connect to Redi</div>
            <div class="transcript-area" id="transcriptArea"></div>
        </div>

        <div class="chat-input-area" id="chatInputArea">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeypress(event)">
            <button class="chat-send" onclick="sendChatMessage()">&rarr;</button>
        </div>

        <div class="controls">
            <div class="control-row">
                <button class="btn btn-primary" id="startBtn" onclick="startSession()">Start Session</button>
            </div>
            <div class="control-row" id="sessionControls" style="display:none">
                <button class="btn btn-icon active" id="micBtn" onclick="toggleMic()">&#x1F3A4;</button>
                <button class="btn btn-icon" id="screenBtn" onclick="toggleScreen()">&#x1F5A5;&#xFE0F;</button>
                <button class="btn btn-icon" id="chatBtn" onclick="toggleChat()">&#x1F4AC;</button>
                <button class="btn btn-icon" id="settingsBtn" onclick="toggleSettings()">&#x2699;&#xFE0F;</button>
                <button class="btn btn-danger btn-icon" onclick="endSession()">&#x2715;</button>
            </div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div class="setting-row">
                <span class="setting-label">Voice</span>
                <select id="voiceSelect" onchange="updateVoice()">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label">Sensitivity</span>
                <select id="sensitivitySelect" onchange="updateSensitivity()">
                    <option value="low">Minimal</option>
                    <option value="medium" selected>Balanced</option>
                    <option value="high">Active</option>
                </select>
            </div>
        </div>

        <div class="disclaimer">Redi is an AI assistant and may make mistakes. Always verify important information.</div>
    </div>

    <script>
        // =====================================================
        // AUTH
        // =====================================================
        var authToken = localStorage.getItem('redi_token');
        var userId = localStorage.getItem('redi_user_id');
        var userName = localStorage.getItem('redi_user_name');
        if (!authToken) window.location.href = '/login';
        fetch('/api/redi/auth/verify', { headers: { 'Authorization': 'Bearer ' + authToken } }).then(function(r) {
            if (!r.ok) { localStorage.removeItem('redi_token'); localStorage.removeItem('redi_user_id'); localStorage.removeItem('redi_user_name'); window.location.href = '/login'; }
        });
        function logout() { localStorage.removeItem('redi_token'); localStorage.removeItem('redi_user_id'); localStorage.removeItem('redi_user_name'); window.location.href = '/login'; }
        if (userName) document.getElementById('userGreeting').textContent = 'Hi, ' + userName;

        // =====================================================
        // STATE
        // =====================================================
        var ws = null;
        var micContext = null;       // AudioContext for mic capture (24kHz)
        var playbackContext = null;  // AudioContext for TTS playback (48kHz, decodes MP3)
        var mediaStream = null;
        var screenStream = null;
        var screenCaptureInterval = null;
        var isConnected = false;
        var isMicOn = true;
        var isScreenOn = false;
        var isChatVisible = false;
        var selectedMode = 'voice';
        var sessionActive = false;

        // Audio queue for gapless MP3 chunk playback
        var audioQueue = [];
        var isPlaying = false;
        var nextPlayTime = 0;

        var SERVER_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/redi?v=9&token=' + encodeURIComponent(authToken || '');

        // =====================================================
        // MODE SELECTION
        // =====================================================
        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-btn').forEach(function(btn) { btn.classList.toggle('selected', btn.dataset.mode === mode); });
        }

        // =====================================================
        // SESSION
        // =====================================================
        function startSession() {
            var startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'Connecting...';

            // Reset audio queue
            audioQueue = [];
            isPlaying = false;
            nextPlayTime = 0;

            try {
                ws = new WebSocket(SERVER_URL);
                ws.onopen = function() {
                    console.log('[WS] Connected');
                    updateStatus('connected', 'Connected');
                    ws.send(JSON.stringify({ type: 'config', voiceOnly: selectedMode === 'voice' || selectedMode === 'observe', drivingMode: false, voice: document.getElementById('voiceSelect').value || '' }));
                    if (selectedMode === 'observe') {
                        ws.send(JSON.stringify({ type: 'observe_start', observeType: 'audio_only', sensitivity: document.getElementById('sensitivitySelect').value }));
                    }
                    sessionActive = true;
                    document.getElementById('modeSelector').style.display = 'none';
                    document.getElementById('sessionControls').style.display = 'flex';
                    startBtn.style.display = 'none';
                    document.getElementById('visualizer').classList.add('active');
                    document.getElementById('responseArea').textContent = selectedMode === 'observe' ? 'Redi is listening...' : 'Redi is ready. Start talking!';
                    if (selectedMode !== 'chat') startMicrophone();
                    if (selectedMode === 'screen') startScreenShare();
                    if (selectedMode === 'chat') { isChatVisible = true; document.getElementById('chatInputArea').classList.add('visible'); }
                };
                ws.onmessage = handleMessage;
                ws.onerror = function(err) { console.error('[WS] Error:', err); updateStatus('error', 'Connection error'); };
                ws.onclose = function() { console.log('[WS] Disconnected'); if (sessionActive) updateStatus('error', 'Disconnected'); };
            } catch (err) {
                console.error('Start error:', err);
                startBtn.disabled = false;
                startBtn.textContent = 'Start Session';
                updateStatus('error', 'Failed to connect');
            }
            loadVoices();
        }

        function endSession() {
            sessionActive = false;
            if (ws) { if (selectedMode === 'observe') ws.send(JSON.stringify({ type: 'observe_stop' })); ws.close(); ws = null; }
            stopMicrophone();
            stopScreenShare();
            audioQueue = [];
            isPlaying = false;
            isConnected = false;
            document.getElementById('modeSelector').style.display = 'flex';
            document.getElementById('sessionControls').style.display = 'none';
            var startBtn = document.getElementById('startBtn');
            startBtn.style.display = 'block'; startBtn.disabled = false; startBtn.textContent = 'Start Session';
            document.getElementById('visualizer').classList.remove('active');
            document.getElementById('responseArea').textContent = 'Session ended.';
            document.getElementById('chatInputArea').classList.remove('visible');
            updateStatus('', 'Disconnected');
        }

        // =====================================================
        // MESSAGE HANDLING
        // =====================================================
        function handleMessage(event) {
            // Binary data = raw audio bytes from server
            if (event.data instanceof Blob) {
                event.data.arrayBuffer().then(function(buffer) { queueAudioChunk(buffer); });
                return;
            }

            try {
                var msg = JSON.parse(event.data);
                switch (msg.type) {
                    case 'session_ready':
                        console.log('[WS] Session ready:', msg.sessionId);
                        updateStatus('connected', 'Session active');
                        break;
                    case 'transcript':
                        if (msg.role === 'assistant') {
                            document.getElementById('responseArea').textContent = msg.text;
                            document.getElementById('responseArea').classList.add('speaking');
                            addTranscript('Redi', msg.text, true);
                            if (msg.brain) {
                                var badge = document.getElementById('brainBadge');
                                badge.style.display = 'inline';
                                badge.textContent = msg.brain === 'fast' ? '\u26A1 Fast' : msg.brain === 'deep' ? '\uD83E\uDDE0 Deep' : '\uD83D\uDDE3\uFE0F Voice';
                            }
                        } else {
                            if (msg.isFinal) { addTranscript('You', msg.text, true); updateStatus('connected', 'Processing...'); }
                        }
                        break;
                    case 'audio':
                        // Base64-encoded audio chunk (MP3 from ElevenLabs)
                        if (msg.data) {
                            var binaryString = atob(msg.data);
                            var bytes = new Uint8Array(binaryString.length);
                            for (var i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                            queueAudioChunk(bytes.buffer);
                        }
                        break;
                    case 'audio_done':
                        document.getElementById('responseArea').classList.remove('speaking');
                        updateStatus('listening', 'Listening...');
                        break;
                    case 'observe_started':
                        updateStatus('listening', 'Always On \u2014 listening...');
                        break;
                    case 'observe_interjection':
                        document.getElementById('responseArea').textContent = msg.text;
                        document.getElementById('responseArea').classList.add('speaking');
                        addTranscript('Redi', msg.text, true);
                        break;
                    case 'observe_ended':
                        updateStatus('connected', 'Observed ' + msg.durationMinutes + 'min, ' + msg.interjectionCount + ' interjections');
                        break;
                    case 'mute_mic': break;
                    case 'stop_audio':
                        // Barge-in: clear audio queue
                        audioQueue = [];
                        isPlaying = false;
                        break;
                    case 'credits_update':
                        document.getElementById('creditCount').textContent = Math.round(msg.remaining);
                        if (msg.remaining <= 2) { document.getElementById('creditBadge').style.background = 'rgba(255,68,68,0.15)'; document.getElementById('creditBadge').style.color = '#FF4444'; }
                        break;
                    case 'error':
                        console.error('[WS] Error:', msg.message);
                        updateStatus('error', msg.message || 'Error');
                        if (msg.action === 'buy_credits') showBuyCredits();
                        if (msg.action === 'login') logout();
                        break;
                }
            } catch (err) {
                console.error('[WS] Parse error:', err);
            }
        }

        // =====================================================
        // MICROPHONE (24kHz PCM16 capture)
        // =====================================================
        function startMicrophone() {
            navigator.mediaDevices.getUserMedia({
                audio: { sampleRate: 24000, channelCount: 1, echoCancellation: true, noiseSuppression: true }
            }).then(function(stream) {
                mediaStream = stream;
                micContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
                var source = micContext.createMediaStreamSource(stream);
                var processor = micContext.createScriptProcessor(4096, 1, 1);
                processor.onaudioprocess = function(e) {
                    if (!ws || ws.readyState !== WebSocket.OPEN || !isMicOn) return;
                    var inputData = e.inputBuffer.getChannelData(0);
                    var pcm16 = new Int16Array(inputData.length);
                    for (var i = 0; i < inputData.length; i++) pcm16[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                    ws.send(pcm16.buffer);
                };
                source.connect(processor);
                processor.connect(micContext.destination);
                updateStatus('listening', 'Listening...');
                isMicOn = true;
                updateMicButton();
            }).catch(function(err) {
                console.error('Microphone error:', err);
                updateStatus('error', 'Mic access denied');
            });
        }

        function stopMicrophone() {
            if (mediaStream) { mediaStream.getTracks().forEach(function(t) { t.stop(); }); mediaStream = null; }
            if (micContext) { micContext.close(); micContext = null; }
        }

        function toggleMic() { isMicOn = !isMicOn; updateMicButton(); }
        function updateMicButton() {
            var btn = document.getElementById('micBtn');
            btn.textContent = isMicOn ? '\uD83C\uDFA4' : '\uD83D\uDD07';
            btn.className = 'btn btn-icon ' + (isMicOn ? 'active' : 'muted');
        }

        // =====================================================
        // AUDIO PLAYBACK (MP3 decoding with queue)
        // =====================================================
        function ensurePlaybackContext() {
            if (!playbackContext || playbackContext.state === 'closed') {
                playbackContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (playbackContext.state === 'suspended') {
                playbackContext.resume();
            }
            return playbackContext;
        }

        function queueAudioChunk(arrayBuffer) {
            var ctx = ensurePlaybackContext();

            // decodeAudioData handles MP3, WAV, OGG, etc. automatically
            ctx.decodeAudioData(arrayBuffer.slice(0), function(audioBuffer) {
                audioQueue.push(audioBuffer);
                if (!isPlaying) {
                    isPlaying = true;
                    nextPlayTime = ctx.currentTime;
                    playNextChunk();
                }
            }, function(err) {
                // If decode fails, try playing as raw PCM16 (fallback)
                console.warn('[Audio] MP3 decode failed, trying PCM16 fallback:', err);
                try {
                    var pcm16 = new Int16Array(arrayBuffer);
                    var float32 = new Float32Array(pcm16.length);
                    for (var i = 0; i < pcm16.length; i++) float32[i] = pcm16[i] / 32768;
                    var buffer = ctx.createBuffer(1, float32.length, 24000);
                    buffer.getChannelData(0).set(float32);
                    audioQueue.push(buffer);
                    if (!isPlaying) { isPlaying = true; nextPlayTime = ctx.currentTime; playNextChunk(); }
                } catch (e) {
                    console.error('[Audio] PCM fallback also failed:', e);
                }
            });
        }

        function playNextChunk() {
            var ctx = ensurePlaybackContext();
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            var buffer = audioQueue.shift();
            var source = ctx.createBufferSource();
            source.buffer = buffer;
            source.connect(ctx.destination);

            // Schedule for gapless playback
            var startTime = Math.max(ctx.currentTime, nextPlayTime);
            source.start(startTime);
            nextPlayTime = startTime + buffer.duration;

            source.onended = function() {
                playNextChunk();
            };
        }

        // =====================================================
        // SCREEN SHARE
        // =====================================================
        function startScreenShare() {
            navigator.mediaDevices.getDisplayMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { max: 1 } } }).then(function(stream) {
                screenStream = stream;
                var video = document.getElementById('screenVideo');
                video.srcObject = stream;
                document.getElementById('screenPreview').classList.add('active');
                isScreenOn = true;
                updateScreenButton();
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                screenCaptureInterval = setInterval(function() {
                    if (!ws || ws.readyState !== WebSocket.OPEN || !isScreenOn) return;
                    canvas.width = Math.min(video.videoWidth, 1280);
                    canvas.height = Math.min(video.videoHeight, 720);
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(function(blob) {
                        if (!blob) return;
                        var reader = new FileReader();
                        reader.onloadend = function() {
                            var base64 = reader.result.split(',')[1];
                            if (selectedMode === 'observe') {
                                ws.send(JSON.stringify({ type: 'observe_screen', content: base64, isOCR: false }));
                            } else {
                                ws.send(JSON.stringify({ type: 'frame', data: base64 }));
                            }
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.7);
                }, selectedMode === 'observe' ? 10000 : 3000);
                stream.getVideoTracks()[0].onended = function() { stopScreenShare(); };
            }).catch(function(err) { console.error('Screen share error:', err); });
        }

        function stopScreenShare() {
            if (screenStream) { screenStream.getTracks().forEach(function(t) { t.stop(); }); screenStream = null; }
            if (screenCaptureInterval) { clearInterval(screenCaptureInterval); screenCaptureInterval = null; }
            document.getElementById('screenPreview').classList.remove('active');
            isScreenOn = false;
            updateScreenButton();
        }

        function toggleScreen() { if (isScreenOn) stopScreenShare(); else startScreenShare(); }
        function updateScreenButton() { document.getElementById('screenBtn').className = 'btn btn-icon ' + (isScreenOn ? 'active' : ''); }

        // =====================================================
        // CHAT
        // =====================================================
        function toggleChat() {
            isChatVisible = !isChatVisible;
            document.getElementById('chatInputArea').classList.toggle('visible', isChatVisible);
            document.getElementById('chatBtn').classList.toggle('active', isChatVisible);
            if (isChatVisible) document.getElementById('chatInput').focus();
        }
        function handleChatKeypress(event) { if (event.key === 'Enter') sendChatMessage(); }
        function sendChatMessage() {
            var input = document.getElementById('chatInput');
            var text = input.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: 'chat', text: text }));
            addTranscript('You', text, true);
            input.value = '';
        }

        // =====================================================
        // UI HELPERS
        // =====================================================
        function updateStatus(state, text) {
            document.getElementById('statusDot').className = 'status-dot ' + state;
            document.getElementById('statusText').textContent = text;
        }
        function addTranscript(speaker, text, isFinal) {
            if (!isFinal) return;
            var area = document.getElementById('transcriptArea');
            var line = document.createElement('div');
            line.className = 'transcript-line' + (speaker === 'Redi' ? ' redi' : '');
            line.innerHTML = '<span class="speaker">' + speaker + '</span>' + escapeHtml(text);
            area.appendChild(line);
            area.scrollTop = area.scrollHeight;
            while (area.children.length > 50) area.removeChild(area.firstChild);
        }
        function escapeHtml(text) { var div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('open'); }

        // =====================================================
        // VOICES
        // =====================================================
        function loadVoices() {
            fetch('/api/voices').then(function(r) { return r