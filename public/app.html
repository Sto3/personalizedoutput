<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Redi — Ready for Anything</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0A0A0A; color: #fff; font-family: 'Georgia', serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        .container { max-width: 500px; width: 100%; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .logo { font-size: 48px; letter-spacing: 8px; color: #00CED1; margin-top: 40px; font-variant: small-caps; }
        .tagline { font-size: 14px; color: #666; margin-top: 4px; font-style: italic; }
        .status-bar { display: flex; align-items: center; gap: 8px; margin-top: 20px; padding: 8px 16px; border-radius: 20px; background: rgba(0,206,209,0.08); font-size: 13px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .status-dot.connected { background: #00CED1; animation: pulse 2s infinite; }
        .status-dot.listening { background: #00FF88; animation: pulse 1s infinite; }
        .status-dot.error { background: #FF4444; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .status-text { color: #888; }
        .brain-badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; background: rgba(0,206,209,0.15); color: #00CED1; }
        .main-area { flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; padding: 20px 0; }
        .visualizer { width: 120px; height: 120px; border-radius: 50%; background: radial-gradient(circle,rgba(0,206,209,0.2) 0%,transparent 70%); display: flex; align-items: center; justify-content: center; }
        .visualizer.active { animation: breathe 3s ease-in-out infinite; }
        .visualizer-inner { width: 60px; height: 60px; border-radius: 50%; background: radial-gradient(circle,rgba(0,206,209,0.4) 0%,rgba(0,206,209,0.1) 100%); }
        @keyframes breathe { 0%,100%{transform:scale(1)} 50%{transform:scale(1.15)} }
        .transcript-area { width: 100%; max-height: 200px; overflow-y: auto; padding: 0 10px; }
        .transcript-line { padding: 6px 0; font-size: 14px; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .transcript-line.redi { color: #00CED1; }
        .transcript-line .speaker { font-size: 11px; color: #666; display: block; margin-bottom: 2px; }
        .response-area { width: 100%; min-height: 60px; padding: 16px; background: rgba(0,206,209,0.05); border-radius: 12px; font-size: 15px; line-height: 1.5; color: #ddd; }
        .response-area.speaking { border: 1px solid rgba(0,206,209,0.3); }
        .controls { width: 100%; display: flex; flex-direction: column; gap: 12px; padding-bottom: 30px; }
        .control-row { display: flex; gap: 12px; justify-content: center; }
        .btn { padding: 14px 24px; border-radius: 12px; border: none; font-family: 'Georgia',serif; font-size: 16px; cursor: pointer; transition: all 0.2s; flex: 1; max-width: 200px; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: #00CED1; color: #000; font-weight: bold; }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }
        .btn-danger { background: rgba(255,68,68,0.8); color: white; }
        .btn-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex: none; max-width: none; }
        .btn-icon.active { background: rgba(0,206,209,0.2); color: #00CED1; }
        .btn-icon.muted { background: rgba(255,68,68,0.2); color: #FF4444; }
        .mode-selector { display: flex; gap: 8px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        .mode-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #333; background: transparent; color: #888; font-size: 13px; cursor: pointer; font-family: 'Georgia',serif; }
        .mode-btn.selected { border-color: #00CED1; color: #00CED1; background: rgba(0,206,209,0.08); }
        .screen-preview { width: 100%; max-height: 200px; border-radius: 8px; overflow: hidden; background: #111; display: none; position: relative; }
        .screen-preview.active { display: block; }
        .screen-preview video { width: 100%; height: auto; }
        .screen-preview .label { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: #00CED1; font-size: 11px; padding: 2px 8px; border-radius: 4px; }
        .settings-panel { width: 100%; background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-top: 12px; display: none; }
        .settings-panel.open { display: block; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .setting-label { font-size: 14px; color: #aaa; }
        select { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 6px 10px; border-radius: 6px; font-family: 'Georgia',serif; }
        .disclaimer { font-size: 11px; color: rgba(255,255,255,0.3); text-align: center; padding: 10px; margin-top: auto; }
        .chat-input-area { width: 100%; display: none; gap: 8px; }
        .chat-input-area.visible { display: flex; }
        .chat-input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #333; background: #111; color: #fff; font-family: 'Georgia',serif; font-size: 14px; outline: none; }
        .chat-input:focus { border-color: #00CED1; }
        .chat-send { width: 44px; height: 44px; border-radius: 50%; background: #00CED1; color: #000; border: none; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>
<div class="container">
    <div class="logo">REDI</div>
    <div class="tagline">for anything</div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:12px">
        <span style="color:#888;font-size:13px" id="userGreeting"></span>
        <span class="brain-badge" id="creditBadge" style="display:inline;background:rgba(0,206,209,0.1);cursor:pointer" onclick="showBuyCredits()"><span id="creditCount">--</span> credits</span>
        <button onclick="logout()" style="background:none;border:1px solid #333;color:#888;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer;font-family:Georgia,serif">Sign Out</button>
    </div>
    <div class="status-bar">
        <div class="status-dot" id="statusDot"></div>
        <span class="status-text" id="statusText">Disconnected</span>
        <span class="brain-badge" id="brainBadge" style="display:none"></span>
    </div>
    <div class="mode-selector" id="modeSelector">
        <button class="mode-btn selected" data-mode="voice" onclick="selectMode('voice')">&#x1F3A4; Voice</button>
        <button class="mode-btn" data-mode="screen" onclick="selectMode('screen')">&#x1F5A5;&#xFE0F; Screen + Voice</button>
        <button class="mode-btn" data-mode="observe" onclick="selectMode('observe')">&#x1F442; Always On</button>
        <button class="mode-btn" data-mode="chat" onclick="selectMode('chat')">&#x1F4AC; Chat Only</button>
    </div>
    <div class="main-area">
        <div class="screen-preview" id="screenPreview"><video id="screenVideo" autoplay muted></video><span class="label">Screen Sharing</span></div>
        <div class="visualizer" id="visualizer"><div class="visualizer-inner"></div></div>
        <div class="response-area" id="responseArea">Press Start to connect to Redi</div>
        <div class="transcript-area" id="transcriptArea"></div>
    </div>
    <div class="chat-input-area" id="chatInputArea">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeypress(event)">
        <button class="chat-send" onclick="sendChatMessage()">&rarr;</button>
    </div>
    <div class="controls">
        <div class="control-row"><button class="btn btn-primary" id="startBtn" onclick="startSession()">Start Session</button></div>
        <div class="control-row" id="sessionControls" style="display:none">
            <button class="btn btn-icon active" id="micBtn" onclick="toggleMic()">&#x1F3A4;</button>
            <button class="btn btn-icon" id="screenBtn" onclick="toggleScreen()">&#x1F5A5;&#xFE0F;</button>
            <button class="btn btn-icon" id="chatBtn" onclick="toggleChat()">&#x1F4AC;</button>
            <button class="btn btn-icon" id="settingsBtn" onclick="toggleSettings()">&#x2699;&#xFE0F;</button>
            <button class="btn btn-danger btn-icon" onclick="endSession()">&#x2715;</button>
        </div>
    </div>
    <div class="settings-panel" id="settingsPanel">
        <div class="setting-row"><span class="setting-label">Voice</span><select id="voiceSelect" onchange="updateVoice()"><option value="">Loading...</option></select></div>
        <div class="setting-row"><span class="setting-label">Sensitivity</span><select id="sensitivitySelect" onchange="updateSensitivity()"><option value="low">Minimal</option><option value="medium" selected>Balanced</option><option value="high">Active</option></select></div>
    </div>
    <div class="disclaimer">Redi is an AI assistant and may make mistakes.</div>
</div>
<script>
// AUTH
var authToken=localStorage.getItem('redi_token'),userId=localStorage.getItem('redi_user_id'),userName=localStorage.getItem('redi_user_name');
if(!authToken)window.location.href='/login';
fetch('/api/redi/auth/verify',{headers:{'Authorization':'Bearer '+authToken}}).then(function(r){if(!r.ok){localStorage.removeItem('redi_token');localStorage.removeItem('redi_user_id');localStorage.removeItem('redi_user_name');window.location.href='/login';}});
function logout(){localStorage.removeItem('redi_token');localStorage.removeItem('redi_user_id');localStorage.removeItem('redi_user_name');window.location.href='/login';}
if(userName)document.getElementById('userGreeting').textContent='Hi, '+userName;

// STATE
var ws=null,micContext=null,playbackContext=null,mediaStream=null,screenStream=null,screenCaptureInterval=null;
var isConnected=false,isMicOn=true,isScreenOn=false,isChatVisible=false,selectedMode='voice',sessionActive=false;

// PCM16 accumulator for smooth playback
var pcmChunks=[];
var pcmFlushTimer=null;
var audioQueue=[];
var isPlaying=false;
var nextPlayTime=0;
var FLUSH_INTERVAL_MS=150; // Accumulate chunks for 150ms then play as one block

var SERVER_URL=(location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws/redi?v=9&token='+encodeURIComponent(authToken||'');

function selectMode(mode){selectedMode=mode;document.querySelectorAll('.mode-btn').forEach(function(b){b.classList.toggle('selected',b.dataset.mode===mode)});}

// SESSION
function startSession(){
    var btn=document.getElementById('startBtn');btn.disabled=true;btn.textContent='Connecting...';
    pcmChunks=[];audioQueue=[];isPlaying=false;nextPlayTime=0;
    try{
        ws=new WebSocket(SERVER_URL);
        ws.onopen=function(){
            console.log('[WS] Connected');updateStatus('connected','Connected');
            ws.send(JSON.stringify({type:'config',voiceOnly:selectedMode==='voice'||selectedMode==='observe',drivingMode:false,voice:document.getElementById('voiceSelect').value||''}));
            if(selectedMode==='observe')ws.send(JSON.stringify({type:'observe_start',observeType:'audio_only',sensitivity:document.getElementById('sensitivitySelect').value}));
            sessionActive=true;
            document.getElementById('modeSelector').style.display='none';
            document.getElementById('sessionControls').style.display='flex';
            btn.style.display='none';
            document.getElementById('visualizer').classList.add('active');
            document.getElementById('responseArea').textContent=selectedMode==='observe'?'Redi is listening...':'Redi is ready. Start talking!';
            if(selectedMode!=='chat')startMicrophone();
            if(selectedMode==='screen')startScreenShare();
            if(selectedMode==='chat'){isChatVisible=true;document.getElementById('chatInputArea').classList.add('visible');}
        };
        ws.onmessage=handleMessage;
        ws.onerror=function(e){console.error('[WS] Error:',e);updateStatus('error','Connection error');};
        ws.onclose=function(){console.log('[WS] Disconnected');if(sessionActive)updateStatus('error','Disconnected');};
    }catch(e){console.error('Start error:',e);btn.disabled=false;btn.textContent='Start Session';updateStatus('error','Failed');}
    loadVoices();
}
function endSession(){
    sessionActive=false;
    if(ws){if(selectedMode==='observe')ws.send(JSON.stringify({type:'observe_stop'}));ws.close();ws=null;}
    stopMicrophone();stopScreenShare();
    pcmChunks=[];audioQueue=[];isPlaying=false;if(pcmFlushTimer){clearTimeout(pcmFlushTimer);pcmFlushTimer=null;}
    isConnected=false;
    document.getElementById('modeSelector').style.display='flex';
    document.getElementById('sessionControls').style.display='none';
    var b=document.getElementById('startBtn');b.style.display='block';b.disabled=false;b.textContent='Start Session';
    document.getElementById('visualizer').classList.remove('active');
    document.getElementById('responseArea').textContent='Session ended.';
    document.getElementById('chatInputArea').classList.remove('visible');
    updateStatus('','Disconnected');
}

// MESSAGE HANDLING
function handleMessage(event){
    if(event.data instanceof Blob){event.data.arrayBuffer().then(function(buf){accumulatePCM(buf);});return;}
    try{
        var m=JSON.parse(event.data);
        switch(m.type){
            case 'session_ready':console.log('[WS] Session ready:',m.sessionId);updateStatus('connected','Session active');break;
            case 'transcript':
                if(m.role==='assistant'){document.getElementById('responseArea').textContent=m.text;document.getElementById('responseArea').classList.add('speaking');addTranscript('Redi',m.text,true);if(m.brain){var bg=document.getElementById('brainBadge');bg.style.display='inline';bg.textContent=m.brain==='fast'?'\u26A1 Fast':m.brain==='deep'?'\uD83E\uDDE0 Deep':'\uD83D\uDDE3\uFE0F Voice';}}
                else{if(m.isFinal){addTranscript('You',m.text,true);updateStatus('connected','Processing...');}}
                break;
            case 'audio':
                if(m.data){var bs=atob(m.data),bytes=new Uint8Array(bs.length);for(var i=0;i<bs.length;i++)bytes[i]=bs.charCodeAt(i);accumulatePCM(bytes.buffer);}
                break;
            case 'audio_done':
                flushPCM();
                document.getElementById('responseArea').classList.remove('speaking');
                updateStatus('listening','Listening...');
                break;
            case 'observe_started':updateStatus('listening','Always On \u2014 listening...');break;
            case 'observe_interjection':document.getElementById('responseArea').textContent=m.text;document.getElementById('responseArea').classList.add('speaking');addTranscript('Redi',m.text,true);break;
            case 'observe_ended':updateStatus('connected','Observed '+m.durationMinutes+'min');break;
            case 'mute_mic':break;
            case 'stop_audio':pcmChunks=[];audioQueue=[];isPlaying=false;if(pcmFlushTimer){clearTimeout(pcmFlushTimer);pcmFlushTimer=null;}break;
            case 'credits_update':document.getElementById('creditCount').textContent=Math.round(m.remaining);if(m.remaining<=2){document.getElementById('creditBadge').style.background='rgba(255,68,68,0.15)';document.getElementById('creditBadge').style.color='#FF4444';}break;
            case 'error':console.error('[WS] Error:',m.message);updateStatus('error',m.message||'Error');if(m.action==='buy_credits')showBuyCredits();if(m.action==='login')logout();break;
        }
    }catch(e){console.error('[WS] Parse error:',e);}
}

// MICROPHONE (24kHz PCM16)
function startMicrophone(){
    navigator.mediaDevices.getUserMedia({audio:{sampleRate:24000,channelCount:1,echoCancellation:true,noiseSuppression:true}}).then(function(stream){
        mediaStream=stream;
        micContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24000});
        var src=micContext.createMediaStreamSource(stream),proc=micContext.createScriptProcessor(4096,1,1);
        proc.onaudioprocess=function(e){
            if(!ws||ws.readyState!==WebSocket.OPEN||!isMicOn)return;
            var inp=e.inputBuffer.getChannelData(0),pcm=new Int16Array(inp.length);
            for(var i=0;i<inp.length;i++)pcm[i]=Math.max(-32768,Math.min(32767,inp[i]*32768));
            ws.send(pcm.buffer);
        };
        src.connect(proc);proc.connect(micContext.destination);
        updateStatus('listening','Listening...');isMicOn=true;updateMicButton();
    }).catch(function(e){console.error('Mic error:',e);updateStatus('error','Mic access denied');});
}
function stopMicrophone(){if(mediaStream){mediaStream.getTracks().forEach(function(t){t.stop()});mediaStream=null;}if(micContext){micContext.close();micContext=null;}}
function toggleMic(){isMicOn=!isMicOn;updateMicButton();}
function updateMicButton(){var b=document.getElementById('micBtn');b.textContent=isMicOn?'\uD83C\uDFA4':'\uD83D\uDD07';b.className='btn btn-icon '+(isMicOn?'active':'muted');}

// =====================================================
// AUDIO PLAYBACK — PCM16 24kHz with accumulation
// =====================================================
// Server sends ElevenLabs PCM16 24kHz as many small chunks.
// We accumulate chunks for FLUSH_INTERVAL_MS, merge into one
// larger buffer, then schedule for gapless playback.
// This eliminates choppiness from playing tiny fragments.

function ensurePlaybackContext(){
    if(!playbackContext||playbackContext.state==='closed')playbackContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24000});
    if(playbackContext.state==='suspended')playbackContext.resume();
    return playbackContext;
}

function accumulatePCM(arrayBuffer){
    pcmChunks.push(new Int16Array(arrayBuffer));
    if(!pcmFlushTimer){
        pcmFlushTimer=setTimeout(function(){flushPCM();},FLUSH_INTERVAL_MS);
    }
}

function flushPCM(){
    if(pcmFlushTimer){clearTimeout(pcmFlushTimer);pcmFlushTimer=null;}
    if(pcmChunks.length===0)return;

    // Merge all accumulated PCM16 chunks into one buffer
    var totalLen=0;
    for(var i=0;i<pcmChunks.length;i++)totalLen+=pcmChunks[i].length;
    var merged=new Int16Array(totalLen);
    var offset=0;
    for(var i=0;i<pcmChunks.length;i++){merged.set(pcmChunks[i],offset);offset+=pcmChunks[i].length;}
    pcmChunks=[];

    // Convert PCM16 to Float32 for Web Audio
    var ctx=ensurePlaybackContext();
    var float32=new Float32Array(merged.length);
    for(var i=0;i<merged.length;i++)float32[i]=merged[i]/32768;

    var buffer=ctx.createBuffer(1,float32.length,24000);
    buffer.getChannelData(0).set(float32);

    // Queue for gapless playback
    audioQueue.push(buffer);
    if(!isPlaying){isPlaying=true;nextPlayTime=ctx.currentTime;playNextChunk();}
}

function playNextChunk(){
    if(audioQueue.length===0){isPlaying=false;return;}
    var ctx=ensurePlaybackContext();
    var buf=audioQueue.shift();
    var src=ctx.createBufferSource();
    src.buffer=buf;
    src.connect(ctx.destination);
    var t=Math.max(ctx.currentTime,nextPlayTime);
    src.start(t);
    nextPlayTime=t+buf.duration;
    src.onended=function(){playNextChunk();};
}

// SCREEN SHARE
function startScreenShare(){
    navigator.mediaDevices.getDisplayMedia({video:{width:{ideal:1280},height:{ideal:720},frameRate:{max:1}}}).then(function(stream){
        screenStream=stream;var vid=document.getElementById('screenVideo');vid.srcObject=stream;
        document.getElementById('screenPreview').classList.add('active');isScreenOn=true;updateScreenButton();
        var canvas=document.createElement('canvas'),cx=canvas.getContext('2d');
        screenCaptureInterval=setInterval(function(){
            if(!ws||ws.readyState!==WebSocket.OPEN||!isScreenOn)return;
            canvas.width=Math.min(vid.videoWidth,1280);canvas.height=Math.min(vid.videoHeight,720);
            cx.drawImage(vid,0,0,canvas.width,canvas.height);
            canvas.toBlob(function(blob){if(!blob)return;var r=new FileReader();r.onloadend=function(){var b64=r.result.split(',')[1];if(selectedMode==='observe')ws.send(JSON.stringify({type:'observe_screen',content:b64,isOCR:false}));else ws.send(JSON.stringify({type:'frame',data:b64}));};r.readAsDataURL(blob);},'image/jpeg',0.7);
        },selectedMode==='observe'?10000:3000);
        stream.getVideoTracks()[0].onended=function(){stopScreenShare();};
    }).catch(function(e){console.error('Screen share error:',e);});
}
function stopScreenShare(){if(screenStream){screenStream.getTracks().forEach(function(t){t.stop()});screenStream=null;}if(screenCaptureInterval){clearInterval(screenCaptureInterval);screenCaptureInterval=null;}document.getElementById('screenPreview').classList.remove('active');isScreenOn=false;updateScreenButton();}
function toggleScreen(){if(isScreenOn)stopScreenShare();else startScreenShare();}
function updateScreenButton(){document.getElementById('screenBtn').className='btn btn-icon '+(isScreenOn?'active':'');}

// CHAT
function toggleChat(){isChatVisible=!isChatVisible;document.getElementById('chatInputArea').classList.toggle('visible',isChatVisible);document.getElementById('chatBtn').classList.toggle('active',isChatVisible);if(isChatVisible)document.getElementById('chatInput').focus();}
function handleChatKeypress(e){if(e.key==='Enter')sendChatMessage();}
function sendChatMessage(){var inp=document.getElementById('chatInput'),txt=inp.value.trim();if(!txt||!ws||ws.readyState!==WebSocket.OPEN)return;ws.send(JSON.stringify({type:'chat',text:txt}));addTranscript('You',txt,true);inp.value='';}

// UI
function updateStatus(s,t){document.getElementById('statusDot').className='status-dot '+s;document.getElementById('statusText').textContent=t;}
function addTranscript(speaker,text,isFinal){if(!isFinal)return;var a=document.getElementById('transcriptArea'),l=document.createElement('div');l.className='transcript-line'+(speaker==='Redi'?' redi':'');l.innerHTML='<span class="speaker">'+speaker+'</span>'+escapeHtml(text);a.appendChild(l);a.scrollTop=a.scrollHeight;while(a.children.length>50)a.removeChild(a.firstChild);}
function escapeHtml(t){var d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function toggleSettings(){document.getElementById('settingsPanel').classList.toggle('open');}

// VOICES
function loadVoices(){fetch('/api/voices').then(function(r){return r.json()}).then(function(d){var s=document.getElementById('voiceSelect');s.innerHTML='<option value="">Default (Brian)</option>';if(d.voices)d.voices.forEach(function(v){var o=document.createElement('option');o.value=v.id;o.textContent=v.name+' \u2014 '+v.description;s.appendChild(o);});}).catch(function(){});}
function updateVoice(){var v=document.getElementById('voiceSelect').value;if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify({type:'config',voice:v}));}
function updateSensitivity(){var v=document.getElementById('sensitivitySelect').value;if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify({type:'config',sensitivity:v}));}

// CREDITS
async function loadCredits(){try{var r=await fetch('/api/redi/billing/balance',{headers:{'Authorization':'Bearer '+authToken}});var d=await r.json();document.getElementById('creditCount').textContent=Math.round(d.credits);if(d.credits<=2){document.getElementById('creditBadge').style.background='rgba(255,68,68,0.15)';document.getElementById('creditBadge').style.color='#FF4444';}}catch(e){}}
async function showBuyCredits(){try{var r=await fetch('/api/redi/billing/packs');var d=await r.json();var h='<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1000;display:flex;align-items:center;justify-content:center" onclick="if(event.target===this)this.remove()"><div style="max-width:400px;width:90%;background:#111;border-radius:16px;padding:24px"><h2 style="color:#00CED1;text-align:center;font-family:Georgia,serif">Add Credits</h2><p style="color:#888;text-align:center;font-size:13px;margin:8px 0 20px">1 credit \u2248 1 minute</p>';d.packs.forEach(function(p){h+='<div onclick="buyPack(\''+p.id+'\')" style="display:flex;justify-content:space-between;align-items:center;padding:14px;margin:8px 0;background:rgba(0,206,209,0.05);border-radius:10px;cursor:pointer;border:1px solid #222"><div><strong style="color:#fff">'+p.name+'</strong><br><span style="color:#888;font-size:12px">'+p.credits+' credits</span></div><span style="color:#00CED1;font-weight:bold">$'+(p.priceInCents/100).toFixed(0)+'</span></div>';});h+='<button onclick="this.parentElement.parentElement.remove()" style="width:100%;margin-top:16px;padding:10px;background:#222;color:#888;border:none;border-radius:8px;cursor:pointer;font-family:Georgia,serif">Cancel</button></div></div>';document.body.insertAdjacentHTML('beforeend',h);}catch(e){}}
async function buyPack(id){var r=await fetch('/api/redi/billing/checkout',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+authToken},body:JSON.stringify({packId:id})});var d=await r.json();if(d.checkoutUrl)window.location.href=d.checkoutUrl;}

// INIT
loadCredits();
if(window.location.search.indexOf('purchase=success')!==-1)setTimeout(loadCredits,2000);
document.addEventListener('click',function(){ensurePlaybackContext();},{once:true});
</script>
</body>
</html>
